<!DOCTYPE html>
<!--
    æ˜¯ä»€ä¹ˆ: HTMLæ–‡æ¡£çš„æ ¹å…ƒç´ ï¼Œè¯­è¨€è®¾ç½®ä¸ºä¸­æ–‡ã€‚
    ä¸ºä»€ä¹ˆ: å£°æ˜è¿™æ˜¯ä¸€ä¸ªHTML5æ–‡æ¡£ï¼Œå¹¶æŒ‡å®šä¸»è¦è¯­è¨€ä¸ºä¸­æ–‡ï¼Œæœ‰åŠ©äºæµè§ˆå™¨å’Œæœç´¢å¼•æ“æ­£ç¡®è§£æã€‚
    å¦‚ä½•å…³è”: è¿™æ˜¯æ•´ä¸ªé¡¹ç›®çš„å…¥å£å’Œéª¨æ¶ï¼Œæ‰¿è½½äº†ã€Šå®ç°Level1.mdã€‹ä¸­è§„åˆ’çš„æ‰€æœ‰å‰ç«¯æŠ€æœ¯å’ŒUIå¸ƒå±€ã€‚
-->
<html lang="zh-CN">
<head>
    <!--
        æ˜¯ä»€ä¹ˆ: æ–‡æ¡£å…ƒæ•°æ®éƒ¨åˆ†ã€‚
        ä¸ºä»€ä¹ˆ: å®šä¹‰å­—ç¬¦é›†ã€è§†å£è®¾ç½®å’Œé¡µé¢æ ‡é¢˜ï¼Œç¡®ä¿è·¨è®¾å¤‡æ­£ç¡®æ˜¾ç¤ºå’Œå“åº”å¼å¸ƒå±€ã€‚
        å¦‚ä½•å…³è”: `viewport` è®¾ç½®æ˜¯ç§»åŠ¨ç«¯ä¼˜å…ˆå’Œå“åº”å¼è®¾è®¡çš„åŸºçŸ³ï¼Œç¬¦åˆç°ä»£Webå¼€å‘æ ‡å‡†ã€‚
    -->    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç ç¼–è¯‘å™¨æ¨¡æ‹Ÿå™¨ v0.8.0</title>

    <!--
        æ˜¯ä»€ä¹ˆ: å¼•å…¥å¤–éƒ¨JavaScriptåº“ã€‚
        ä¸ºä»€ä¹ˆ:
            - tailwindcss: ç”¨äºå¿«é€Ÿæ„å»ºUIï¼Œå®ç°ç°ä»£åŒ–çš„åŸå­åŒ–CSSå¸ƒå±€ã€‚
            - d3.js: ä¸€ä¸ªå¼ºå¤§çš„æ•°æ®å¯è§†åŒ–åº“ï¼Œç”¨äºç»˜åˆ¶æŠ½è±¡è¯­æ³•æ ‘(AST)ã€‚
            - chart.js: ç”¨äºåˆ›å»ºåŠ¨æ€çš„æ€§èƒ½å›¾è¡¨ã€‚
            - decimal.js: ç”¨äºå¤„ç†å¤§æ•°è¿ç®—ï¼Œé˜²æ­¢JavaScriptåŸç”ŸNumberç±»å‹çš„ç²¾åº¦ä¸¢å¤±é—®é¢˜ã€‚
        å¦‚ä½•å…³è”:
            - è¿™å®Œå…¨å¯¹åº”äº†ã€Šå®ç°Level1.mdã€‹ä¸­â€œæ ¸å¿ƒåº“é€‰æ‹©â€éƒ¨åˆ†çš„æŠ€æœ¯æ ˆè§„åˆ’ã€‚
            - `decimal.js` çš„ä½¿ç”¨æ˜¯ä¸ºäº†è§£å†³ã€Šç ”ç©¶Level1.mdã€‹ä¸­æåˆ°çš„â€œæŒ‡æ•°å¢é•¿â€å¸¦æ¥çš„â€œå¤©æ–‡æ•°å­—â€é—®é¢˜ã€‚
    -->
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/decimal.js/decimal.min.js"></script>

    <!--
        æ˜¯ä»€ä¹ˆ: å¼•å…¥CodeMirrorä»£ç ç¼–è¾‘å™¨åº“åŠå…¶ç›¸å…³CSSã€‚
        ä¸ºä»€ä¹ˆ: æä¾›ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ã€å¸¦è¯­æ³•é«˜äº®çš„åµŒå…¥å¼ä»£ç ç¼–è¾‘å™¨ï¼Œè®©ç©å®¶å¯ä»¥è¾“å…¥å’ŒæŸ¥çœ‹ä»£ç ã€‚
        å¦‚ä½•å…³è”: è¿™æ˜¯å®ç°ã€Šç ”ç©¶Level1.mdã€‹3.3.3èŠ‚â€œæ¸¸æˆå†…ä»£ç ç¼–è¾‘å™¨â€å’Œã€Šå®ç°Level1.mdã€‹â€œä»£ç ç¼–è¾‘å™¨â€åŠŸèƒ½ç‚¹çš„ç›´æ¥æŠ€æœ¯é€‰å‹ã€‚
    -->
    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">


    <!--
        æ˜¯ä»€ä¹ˆ: å¼•å…¥å¤–éƒ¨å­—ä½“ 'IBM Plex Mono'ã€‚
        ä¸ºä»€ä¹ˆ: ä½¿ç”¨ç­‰å®½å­—ä½“æ¥å¼ºåŒ–â€œç¼–ç¨‹â€å’Œâ€œé»‘å®¢â€çš„ä¸»é¢˜æ„Ÿï¼Œè¿™åœ¨ä»£ç ç¼–è¾‘å™¨å’Œç»ˆç«¯æ¨¡æ‹Ÿä¸­å¾ˆå¸¸è§ã€‚
        å¦‚ä½•å…³è”: å¯¹åº”ã€Šç ”ç©¶Level1.mdã€‹3.3.1èŠ‚ä¸­æåˆ°çš„â€œå¹¿æ³›ä½¿ç”¨ç­‰å®½å­—ä½“ï¼ˆMonospaceï¼‰â€çš„UIè®¾è®¡å»ºè®®ã€‚
    -->
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /*
            æ˜¯ä»€ä¹ˆ: å®šä¹‰å…¨å±€CSSå˜é‡ï¼ˆè‡ªå®šä¹‰å±æ€§ï¼‰ã€‚
            ä¸ºä»€ä¹ˆ: å°†é¢œè‰²ã€å­—ä½“ç­‰è®¾è®¡å…ƒç´ é›†ä¸­ç®¡ç†ï¼Œæ–¹ä¾¿ç»Ÿä¸€ä¿®æ”¹å’Œç»´æŠ¤ï¼Œå®ç°ä¸»é¢˜åŒ–ã€‚
            å¦‚ä½•å…³è”: è¿™é‡Œçš„é¢œè‰²å˜é‡ï¼ˆå¦‚--accent-green, --accent-cyanï¼‰ç›´æ¥å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­â€œé»‘å®¢ç¾å­¦é£æ ¼æŒ‡å—â€å®šä¹‰çš„è‰²æ¿ã€‚
        */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --border-color: #30363d;
            --accent-green: #23d18b;
            --accent-cyan: #39c5fe;
            --accent-magenta: #f778ba;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --font-mono: 'IBM Plex Mono', monospace;
        }

        /*
            æ˜¯ä»€ä¹ˆ: åŸºç¡€é¡µé¢æ ·å¼ã€‚
            ä¸ºä»€ä¹ˆ: è®¾ç½®å…¨å±€å­—ä½“ã€èƒŒæ™¯è‰²å’Œæ–‡å­—é¢œè‰²ï¼Œå¥ å®šæ•´ä½“è§†è§‰é£æ ¼ã€‚
            å¦‚ä½•å…³è”: åº”ç”¨äº†ã€Šå®ç°Level1.mdã€‹ä¸­å®šä¹‰çš„â€œé»‘å®¢ç¾å­¦â€å­—ä½“å’ŒèƒŒæ™¯è‰²ã€‚
        */
        body {
            font-family: var(--font-mono);
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .hacker-box {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: var(--accent-green);
            color: var(--bg-primary);
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(35, 209, 139, 0.4);
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(35, 209, 139, 0.7);
        }
        .btn-primary:disabled {
            background-color: #21262d;
            border-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-secondary {
            background-color: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(57, 197, 254, 0.4);
        }        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(57, 197, 254, 0.7);
        }

        /* ç¬¬ä¸‰é˜¶æ®µä¸“å±æ ·å¼ */
        .btn-mini {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }

        .optimization-tech {
            transition: all 0.3s ease;
        }
        .optimization-tech:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .deployment-platform {
            transition: all 0.3s ease;
        }
        .deployment-platform:hover:not(.opacity-50) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* ç¬¬ä¸‰é˜¶æ®µé¢æ¿æ¸å˜èƒŒæ™¯ */
        .stage3-panel {
            background: linear-gradient(135deg, rgba(139, 69, 19, 0.1) 0%, rgba(75, 0, 130, 0.1) 100%);
            border: 1px solid rgba(147, 51, 234, 0.3);
        }        /* æ€§èƒ½è¯„çº§æ ·å¼ */
        .performance-rating {
            text-shadow: 0 0 10px currentColor;
            animation: pulse-rating 2s infinite;
        }
        @keyframes pulse-rating {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tab-navigation {
            margin-bottom: 1.5rem;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: rgba(55, 65, 81, 0.8);
            color: var(--text-secondary);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        .tab-btn:hover {
            background: rgba(75, 85, 99, 0.9);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            color: var(--bg-primary);
            box-shadow: 0 0 15px rgba(57, 197, 254, 0.4);
        }
        .tab-panel {
            display: none;
            animation: fadeInTab 0.3s ease-in-out;
        }
        .tab-panel.active {
            display: block;
        }
        @keyframes fadeInTab {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ”¹è¿›çš„ç½‘æ ¼å¸ƒå±€ */
        #stats-container {
            display: grid;
            gap: 1rem;
        }
        .stat-item {
            background: rgba(55, 65, 81, 0.3);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .stat-item:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(57, 197, 254, 0.2);
        }

        /* æ˜¯ä»€ä¹ˆ: â€œæ•…éšœè‰ºæœ¯â€ (Glitch) æ•ˆæœçš„CSSå®ç°ã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯ä¸€ç§éå¸¸æµè¡Œçš„è§†è§‰é£æ ¼ï¼Œèƒ½æå¤§åœ°å¢å¼ºâ€œé»‘å®¢â€æˆ–â€œèµ›åšæœ‹å…‹â€çš„ä¸»é¢˜æ„Ÿï¼Œè®©UIçœ‹èµ·æ¥æ›´â€œé…·â€ã€‚
            å¦‚ä½•å…³è”: ç›´æ¥å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­â€œUI/UX è®¾è®¡è§„èŒƒâ€é‡Œå±•ç¤ºçš„`.glitch` CSSä»£ç ï¼Œæ˜¯â€œé»‘å®¢ç¾å­¦â€çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚
        */
        .glitch {
            position: relative;
            color: var(--accent-green);
            text-shadow: 0 0 5px var(--accent-green);
        }
        .glitch::before,
        .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            overflow: hidden;
        }
        .glitch::before {
            left: 2px;
            text-shadow: -2px 0 var(--accent-magenta);
            animation: glitch-anim-1 2s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px;
            text-shadow: -2px 0 var(--accent-cyan), 2px 2px var(--accent-magenta);
            animation: glitch-anim-2 2s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim-1 { 0% { clip-path: inset(5% 0 90% 0); } 100% { clip-path: inset(80% 0 5% 0); } }
        @keyframes glitch-anim-2 { 0% { clip-path: inset(70% 0 10% 0); } 100% { clip-path: inset(10% 0 85% 0); } }

        /* æ˜¯ä»€ä¹ˆ: CodeMirrorç¼–è¾‘å™¨çš„æ ·å¼è¦†ç›–ã€‚
            ä¸ºä»€ä¹ˆ: ä¸ºäº†è®©CodeMirrorçš„é»˜è®¤å¤–è§‚èƒ½æ›´å¥½åœ°èå…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„â€œé»‘å®¢â€ä¸»é¢˜ã€‚
            å¦‚ä½•å…³è”: è°ƒæ•´ç¼–è¾‘å™¨æ ·å¼ä»¥åŒ¹é…ã€Šå®ç°Level1.mdã€‹ä¸­å®šä¹‰çš„æ•´ä½“è§†è§‰é£æ ¼ã€‚
        */
        .CodeMirror {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            height: 250px;
            font-family: var(--font-mono);
        }
        .CodeMirror-gutters {
            background: #282a36 !important; /* Dracula theme background */
        }

        /* æ˜¯ä»€ä¹ˆ: è¯æ³•åˆ†æåç”Ÿæˆçš„â€œä»¤ç‰Œâ€(Token)çš„å¯è§†åŒ–æ ·å¼ã€‚
            ä¸ºä»€ä¹ˆ: é€šè¿‡ä¸åŒé¢œè‰²åŒºåˆ†ä¸åŒç±»å‹çš„Tokenï¼ˆå…³é”®å­—ã€æ ‡è¯†ç¬¦ç­‰ï¼‰ï¼Œä¸ºç©å®¶æä¾›æ¸…æ™°ã€ç›´è§‚çš„è§†è§‰åé¦ˆã€‚
            å¦‚ä½•å…³è”: è¿™æ˜¯å®ç°ã€Šå®ç°Level1.mdã€‹ä¸­â€œé˜¶æ®µä¸€ï¼šè¯æ³•åˆ†æâ€é‡Œæåˆ°çš„â€œä»£ç å­—ç¬¦ä¸²é€ä¸ªåˆ†è§£ä¸ºå½©è‰²tokenå—â€çš„å¯è§†åŒ–æ•ˆæœã€‚
        */
        #token-stream {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px;
            min-height: 100px;
        }
        .token {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .token-KEYWORD { background-color: #ff79c6; color: black; }
        .token-IDENTIFIER { background-color: #f8f8f2; color: black; }
        .token-NUMBER { background-color: #f1fa8c; color: black; }
        .token-STRING { background-color: #50fa7b; color: black; }
        .token-OPERATOR { background-color: #8be9fd; color: black; }
        .token-DELIMITER { background-color: #bd93f9; color: black; }        .token-UNKNOWN { background-color: #ff5555; color: white; }

        /* å¨æœ›å¼¹çª—æ ·å¼ */
        .prestige-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease;
        }

        .prestige-popup-content {
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e);
            border: 3px solid var(--accent-green);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 0 50px var(--accent-green);
            font-family: var(--font-mono);
        }

        .prestige-summary {
            margin: 20px 0;
            color: var(--text-primary);
        }

        .prestige-summary p {
            margin: 10px 0;
            font-size: 16px;
        }

        .close-btn {
            background: var(--accent-green);
            color: var(--bg-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-family: var(--font-mono);
            transition: all 0.3s ease;
        }        .close-btn:hover {
            background: var(--accent-cyan);
            transform: scale(1.05);
        }

        /* è´­ä¹°æ•°é‡é€‰æ‹©å™¨æ ·å¼ */
        .buy-amount-selector {
            display: flex;
            align-items: center;
        }
        .buy-amount-btn {
            padding: 0.5rem 1rem;
            margin: 0 2px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .buy-amount-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }
        .buy-amount-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
            border-color: var(--accent-cyan);
        }

    </style>
</head>
<body class="p-4 md:p-8">

<!--
    æ˜¯ä»€ä¹ˆ: é¡µé¢ä¸»ä½“ç»“æ„ï¼Œé‡‡ç”¨Gridå¸ƒå±€ã€‚
    ä¸ºä»€ä¹ˆ: ä½¿ç”¨Gridå¸ƒå±€å¯ä»¥è½»æ¾å®ç°å¤æ‚çš„å“åº”å¼é¡µé¢ç»“æ„ï¼Œåœ¨å¤§å±å¹•ä¸Šåˆ†ä¸ºå·¦å³ä¸¤æ ï¼Œåœ¨å°å±å¹•ä¸Šè‡ªåŠ¨å †å ã€‚
    å¦‚ä½•å…³è”: è¿™æ˜¯ã€Šå®ç°Level1.mdã€‹ä¸­â€œä»ªè¡¨ç›˜å¸ƒå±€â€çš„å®è§‚å®ç°ï¼Œå°†é¡µé¢åˆ’åˆ†ä¸ºå·¦ä¾§çš„äº¤äº’åŒºï¼ˆç¼–è¾‘å™¨ï¼‰å’Œå³ä¾§çš„çŠ¶æ€/å‡çº§åŒºã€‚
-->
<div class="max-w-7xl mx-auto">
    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold glitch" data-text="ä»£ç ç¼–è¯‘å™¨æ¨¡æ‹Ÿå™¨">ä»£ç ç¼–è¯‘å™¨æ¨¡æ‹Ÿå™¨</h1>
        <p id="version-display" class="text-sm text-gray-400 mt-2">v0.8.0 - Tabs Fix</p>
    </header>    <main class="space-y-6">
        <!-- ä¸»è¦çŠ¶æ€é¢æ¿ - å§‹ç»ˆå¯è§ -->
        <div class="hacker-box p-6">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ–¥ï¸ ç¼–è¯‘å™¨çŠ¶æ€</h2>
            <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        </div>

        <!-- å¨æœ›é¢æ¿ - ç‹¬ç«‹æ˜¾ç¤º -->
        <div class="hacker-box p-6" id="prestige-panel" style="display: none;">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">âš¡ ç³»ç»Ÿé‡æ„ (å¨æœ›)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                <div>
                    <p class="text-sm text-gray-400 mb-2">é‡æ„ç¼–è¯‘å™¨æ ¸å¿ƒä»¥è·å¾—æ°¸ä¹…æ€§åŠ æˆ</p>
                    <p class="text-lg">å¯è·å¾— <span id="prestige-gain-display" class="font-bold text-yellow-400">0</span> ç¼–è¯‘å™¨ç‚¹æ•°</p>
                </div>
                <button id="prestige-btn" class="btn btn-secondary">æ‰§è¡Œé‡æ„</button>
            </div>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="hacker-box p-6">
            <div class="tab-navigation mb-6">
                <div class="flex space-x-1 bg-gray-800 p-1 rounded-lg">
                    <button class="tab-btn active" data-tab="upgrades">ğŸ”§ å‡çº§</button>
                    <button class="tab-btn" data-tab="analytics">ğŸ“Š åˆ†æ</button>
                    <button class="tab-btn" data-tab="stage3" id="stage3-tab" style="display: none;">ğŸš€ ä»£ç ç”Ÿæˆ</button>
                    <button class="tab-btn" data-tab="lexer">âš™ï¸ è¯æ³•åˆ†æ</button>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µå†…å®¹ -->
            <div class="tab-content">                <!-- å‡çº§æ ‡ç­¾é¡µ -->
                <div id="upgrades-tab" class="tab-panel active">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">ç¼–è¯‘å™¨å‡çº§</h2>
                        <div class="buy-amount-selector">
                            <span class="text-sm text-gray-400 mr-2">è´­ä¹°æ•°é‡:</span>
                            <button class="buy-amount-btn active" data-amount="1" onclick="game.setBuyAmount(1)">x1</button>
                            <button class="buy-amount-btn" data-amount="10" onclick="game.setBuyAmount(10)">x10</button>
                            <button class="buy-amount-btn" data-amount="100" onclick="game.setBuyAmount(100)">x100</button>
                        </div>
                    </div>
                    <div id="upgrades-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>

                <!-- åˆ†ææ ‡ç­¾é¡µ -->
                <div id="analytics-tab" class="tab-panel">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h2 class="text-xl font-bold mb-4">æ€§èƒ½å›¾è¡¨</h2>
                            <div class="relative h-64">
                                <canvas id="performance-chart"></canvas>
                            </div>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-4">æŠ½è±¡è¯­æ³•æ ‘ (AST)</h2>
                            <div id="ast-visualization" class="w-full h-64 flex items-center justify-center border border-gray-600 rounded"></div>
                        </div>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰é˜¶æ®µæ ‡ç­¾é¡µ -->
                <div id="stage3-tab-content" class="tab-panel" style="display: none;">
                    <h2 class="text-xl font-bold mb-4">ğŸ”§ ä»£ç ç”Ÿæˆå·¥å‚</h2>
                    <div class="space-y-6">
                        <!-- ä»£ç ç”Ÿæˆæµæ°´çº¿ -->
                        <div class="assembly-line bg-gray-800 p-4 rounded">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                                <div class="input-section text-center">
                                    <span class="text-sm text-gray-400">ASTèŠ‚ç‚¹</span>
                                    <div class="resource-flow text-cyan-400 text-2xl">ğŸ“Š</div>
                                </div>
                                <div class="generation-process">
                                    <div class="text-center">
                                        <div class="progress-bar bg-gray-700 h-3 rounded mb-2">
                                            <div id="code-gen-progress" class="bg-gradient-to-r from-cyan-400 to-green-400 h-full rounded transition-all"></div>
                                        </div>
                                        <span id="generator-type" class="text-sm text-gray-300">åŸºç¡€ä»£ç ç”Ÿæˆ</span>
                                    </div>
                                </div>
                                <div class="output-section text-center">
                                    <span class="text-sm text-gray-400">ç”Ÿæˆä»£ç </span>
                                    <div class="code-blocks text-green-400 text-xl">âš¡ <span id="generated-code-count">0</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- ä¼˜åŒ–å’Œæ€§èƒ½é¢æ¿ -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="optimization-panel bg-gray-800 p-4 rounded">
                                <h3 class="text-lg font-bold mb-3 text-purple-400">ğŸš€ ä¼˜åŒ–æŠ€æœ¯æ ‘</h3>
                                <div id="optimization-techs" class="grid grid-cols-1 gap-3 max-h-64 overflow-y-auto">
                                    <!-- ä¼˜åŒ–æŠ€æœ¯å°†åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>

                            <div class="performance-dashboard bg-gray-800 p-4 rounded">
                                <h3 class="text-lg font-bold mb-3 text-yellow-400">ğŸ“Š æ€§èƒ½ä»ªè¡¨ç›˜</h3>
                                <div class="space-y-4">
                                    <div class="performance-rating text-center">
                                        <div id="performance-rating" class="text-3xl font-bold text-gray-400 performance-rating">F</div>
                                        <div id="performance-score" class="text-sm text-gray-500">0 åˆ†</div>
                                    </div>
                                    <div class="deployment-platforms">
                                        <h4 class="text-sm font-bold mb-2 text-orange-400">ğŸŒ éƒ¨ç½²å¹³å°</h4>
                                        <div id="deployment-platforms" class="grid grid-cols-2 gap-2">
                                            <!-- éƒ¨ç½²å¹³å°æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è¯æ³•åˆ†ææ ‡ç­¾é¡µ - ä¿ç•™ä½†ç®€åŒ– -->
                <div id="lexer-tab" class="tab-panel">
                    <h2 class="text-xl font-bold mb-4">è¯æ³•åˆ†æå™¨</h2>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">ä»£ç è¾“å…¥</label>
                                <textarea id="code-input" class="w-full h-32 bg-gray-800 border border-gray-600 rounded p-3 text-sm font-mono"
                                    placeholder="è¾“å…¥ä»£ç è¿›è¡Œè¯æ³•åˆ†æ...">function hello() {
    return "Hello World!";
}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-400 mb-2">ä»¤ç‰Œè¾“å‡º</label>
                                <div id="token-stream" class="h-32 bg-gray-900 border border-gray-600 rounded p-3 overflow-y-auto"></div>
                            </div>
                        </div>
                        <button id="run-lexer-btn" class="btn btn-primary">ğŸ” æ‰§è¡Œè¯æ³•åˆ†æ</button>
                        <p class="text-xs text-gray-500">ğŸ’¡ æç¤ºï¼šè¯æ³•åˆ†æä¸»è¦ç”¨äºæ¸¸æˆæ—©æœŸè·å–tokensï¼ŒåæœŸè‡ªåŠ¨åŒ–å‡çº§åä½œç”¨æœ‰é™</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- å¼€å‘è€…æç¤º - åªåœ¨æ§åˆ¶å°å¯è§ -->
    <script>
        console.log('ğŸ® å¼€å‘è€…æç¤ºï¼š');
        console.log('ğŸ® æŒ‰ Ctrl + Shift + D æ¿€æ´»å¼€å‘è€…æ¨¡å¼');
        console.log('ğŸ® æ¿€æ´»åå¯ä»¥ä½¿ç”¨æ•°å­—é”®å¿«é€Ÿè·å¾—èµ„æº');
    </script>
</div>

<script>
    // --- é…ç½®ä¸è®¾ç½® ---
    /*
        æ˜¯ä»€ä¹ˆ: è®¾ç½®Decimal.jsåº“çš„å…¨å±€ç²¾åº¦å’Œèˆå…¥æ¨¡å¼ã€‚
        ä¸ºä»€ä¹ˆ: å¢é‡æ¸¸æˆä¸­çš„æ•°å€¼ä¼šå˜å¾—æå¤§ï¼Œè¿œè¿œè¶…è¿‡JavaScript `Number`ç±»å‹çš„å®‰å…¨èŒƒå›´ã€‚è®¾ç½®é«˜ç²¾åº¦å¯ç¡®ä¿æ‰€æœ‰è®¡ç®—ï¼ˆç‰¹åˆ«æ˜¯æˆæœ¬å’Œäº§å‡ºï¼‰çš„å‡†ç¡®æ€§ã€‚
        å¦‚ä½•å…³è”: è¿™æ˜¯å®ç°ã€Šç ”ç©¶Level1.mdã€‹1.3èŠ‚â€œæŒ‡æ•°å¢é•¿â€å’Œ3.2.1èŠ‚â€œç®¡ç†å¤©æ–‡æ•°å­—â€çš„æŠ€æœ¯å‰æã€‚
    */
    Decimal.set({ precision: 100, rounding: 4 });

    // --- æ¸¸æˆæ•°æ® ---
    /*
        æ˜¯ä»€ä¹ˆ: å®šä¹‰äº†æ‰€æœ‰å¯è´­ä¹°å‡çº§çš„æ ¸å¿ƒæ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œæ˜¯æ¸¸æˆçš„â€œè“å›¾â€ã€‚
        ä¸ºä»€ä¹ˆ: å°†æ¸¸æˆå¹³è¡¡æ€§ç›¸å…³çš„æ•°å€¼ï¼ˆå¦‚åŸºç¡€æˆæœ¬ã€æˆé•¿ç‡ã€äº§å‡ºï¼‰é›†ä¸­å­˜æ”¾ï¼Œä¾¿äºè°ƒæ•´å’Œç®¡ç†ï¼Œè€Œæ— éœ€åœ¨ä»£ç é€»è¾‘ä¸­ç¡¬ç¼–ç ã€‚
        å¦‚ä½•å…³è”:
            - è¿™æ®µä»£ç æ˜¯ã€Šå®ç°Level1.mdã€‹ä¸­â€œå‡çº§é¡¹ç›®è®¾è®¡â€è¡¨æ ¼çš„ç›´æ¥ä»£ç åŒ–å®ç°ã€‚
            - `baseCost`å’Œ`growth`ç›´æ¥å¯¹åº”äº†ã€Šç ”ç©¶Level1.mdã€‹1.3èŠ‚ä¸­çš„æŒ‡æ•°æˆæœ¬å…¬å¼ `Cost_next = Cost_base * (Rate_growth)^Owned`ã€‚
            - `type`ï¼ˆmanual, generator, converterï¼‰å®šä¹‰äº†å‡çº§çš„æ€§è´¨ï¼Œä½“ç°äº†æ¸¸æˆä»æ‰‹åŠ¨åˆ°è‡ªåŠ¨ï¼ˆgeneratorï¼‰ï¼Œå†åˆ°èµ„æºè½¬åŒ–ï¼ˆconverterï¼‰çš„æ ¸å¿ƒè¿›ç¨‹ï¼Œè¿™ä¸ã€Šç ”ç©¶Level1.mdã€‹ä¸­æè¿°çš„æ¸¸æˆé˜¶æ®µæ¼”è¿›ï¼ˆè¯æ³•åˆ†æ -> è¯­æ³•åˆ†æï¼‰ç›¸ç¬¦ã€‚
            - `unlockThreshold`å®ç°äº†ã€Šç ”ç©¶Level1.mdã€‹ä¸­æåˆ°çš„â€œå±•å¼€å¼æœºåˆ¶â€ï¼Œé¿å…ä¸€æ¬¡æ€§ç»™ç©å®¶å¤ªå¤šä¿¡æ¯ã€‚
    */
    const UPGRADE_DATA = {
        'token-speed': { name: 'è¯æ³•åˆ†æå™¨ I', description: 'æå‡æ‰‹åŠ¨åˆ†è¯æ•ˆç‡ (æŒ‰Tokenæ•°é‡)ã€‚', baseCost: new Decimal(25), growth: 1.25, baseOutput: new Decimal(0.1), type: 'manual' },
        'auto-tokenizer-1': { name: 'è‡ªåŠ¨åŒ–åˆ†è¯å™¨', description: 'è‡ªåŠ¨äº§ç”Ÿ Tokensã€‚', baseCost: new Decimal(50), growth: 1.15, baseOutput: new Decimal(1), type: 'generator', resource: 'tokens' },
        'auto-scanner-2': { name: 'é«˜é€Ÿæ‰«æå™¨', description: 'æ›´å¿«é€Ÿçš„è‡ªåŠ¨åŒ–åˆ†è¯å™¨ã€‚', baseCost: new Decimal(500), growth: 1.18, baseOutput: new Decimal(5), type: 'generator', resource: 'tokens', unlockThreshold: new Decimal(250) },
        'parallel-lexer-3': { name: 'å¹¶è¡Œè¯æ³•åˆ†æå™¨', description: 'åˆ©ç”¨å¤šæ ¸å¿ƒå¹¶è¡Œå¤„ç†ï¼Œå¤§å¹…æå‡æ•ˆç‡ã€‚', baseCost: new Decimal(8000), growth: 1.22, baseOutput: new Decimal(25), type: 'generator', resource: 'tokens', unlockThreshold: new Decimal(4000) },
        'auto-parser-1': { name: 'è‡ªåŠ¨åŒ–è§£æå™¨', description: 'æ¶ˆè€— Tokens è‡ªåŠ¨æ„å»º AST èŠ‚ç‚¹ã€‚', baseCost: new Decimal(1000), growth: 1.20, baseOutput: new Decimal(0.5), type: 'converter', resource: 'astNodes', costResource: 'tokens', unlockThreshold: new Decimal(500) },
    };    const PRESTIGE_UPGRADES = {
        'quantumTokenizer': { name: "é‡å­åˆ†è¯å™¨", baseCost: new Decimal(10), cost: new Decimal(10), level: 0, effect: "tokensç”Ÿäº§ Ã— 5", requiresPrestige: 1, unlocked: false },
        'parallelCompiler': { name: "å¹¶è¡Œç¼–è¯‘å™¨", baseCost: new Decimal(100), cost: new Decimal(100), level: 0, effect: "åŒæ—¶å¤„ç†å¤šä¸ªç¼–è¯‘ä»»åŠ¡", requiresPrestige: 3, unlocked: false },
        'aiOptimizer': { name: "AIä¼˜åŒ–å™¨", baseCost: new Decimal(1000), cost: new Decimal(1000), level: 0, effect: "è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç¼–è¯‘ç­–ç•¥", requiresPrestige: 5, unlocked: false }
    };

    // ç¬¬ä¸‰é˜¶æ®µï¼šä»£ç ç”Ÿæˆä¸ä¼˜åŒ– - å‡çº§æ•°æ®
    const STAGE3_UPGRADES = {
        'basicCodeGen': { 
            name: "åŸºç¡€ä»£ç ç”Ÿæˆå™¨", 
            baseCost: new Decimal(100), 
            growth: 1.2, 
            baseOutput: new Decimal(0.1), 
            type: 'converter', 
            resource: 'generatedCode',
            costResource: 'astNodes',
            description: "å°†ASTèŠ‚ç‚¹è½¬æ¢ä¸ºåŸºç¡€ä»£ç ",
            unlockThreshold: new Decimal(1000)
        },
        'llvmCodeGen': { 
            name: "LLVMä»£ç ç”Ÿæˆå™¨", 
            baseCost: new Decimal(1000), 
            growth: 1.25, 
            baseOutput: new Decimal(0.15), 
            type: 'converter', 
            resource: 'generatedCode',
            costResource: 'astNodes',
            description: "é«˜æ•ˆçš„LLVMåç«¯ä»£ç ç”Ÿæˆ",
            unlockThreshold: new Decimal(5000)
        },
        'jitCompiler': { 
            name: "JITç¼–è¯‘å™¨", 
            baseCost: new Decimal(10000), 
            growth: 1.3, 
            baseOutput: new Decimal(0.2), 
            type: 'converter', 
            resource: 'generatedCode',
            costResource: 'astNodes',
            description: "å®æ—¶ç¼–è¯‘ï¼Œæ•ˆç‡Ã—2",
            unlockThreshold: new Decimal(50000)
        }
    };

    // ä»£ç ä¼˜åŒ–æŠ€æœ¯æ•°æ®
    const OPTIMIZATION_TECHS = {
        'deadCodeElimination': {
            name: "æ­»ä»£ç æ¶ˆé™¤",
            maxLevel: 10,
            baseCost: new Decimal(50),
            growth: 1.6,
            efficiency: 0.1,
            description: "ç§»é™¤æ°¸è¿œä¸ä¼šæ‰§è¡Œçš„ä»£ç "
        },
        'loopOptimization': {
            name: "å¾ªç¯ä¼˜åŒ–", 
            maxLevel: 8,
            baseCost: new Decimal(200),
            growth: 1.8,
            efficiency: 0.15,
            description: "å¾ªç¯å±•å¼€å’Œå‘é‡åŒ–ä¼˜åŒ–"
        },
        'functionInlining': {
            name: "å‡½æ•°å†…è”",
            maxLevel: 5, 
            baseCost: new Decimal(500),
            growth: 2.0,
            efficiency: 0.2,
            description: "æ¶ˆé™¤å‡½æ•°è°ƒç”¨å¼€é”€"
        },
        'registerAllocation': {
            name: "å¯„å­˜å™¨åˆ†é…",
            maxLevel: 12,
            baseCost: new Decimal(100),
            growth: 1.5,
            efficiency: 0.05,
            description: "ä¼˜åŒ–CPUå¯„å­˜å™¨ä½¿ç”¨"
        }
    };

    // éƒ¨ç½²å¹³å°æ•°æ®
    const DEPLOYMENT_PLATFORMS = {
        'development': { name: "å¼€å‘ç¯å¢ƒ", multiplier: 1.0, unlocked: true },
        'serverCluster': { name: "æœåŠ¡å™¨é›†ç¾¤", multiplier: 2.5, unlockThreshold: new Decimal(10000) },
        'edgeComputing': { name: "è¾¹ç¼˜è®¡ç®—", multiplier: 5.0, unlockThreshold: new Decimal(100000) },
        'quantumProcessor': { name: "é‡å­å¤„ç†å™¨", multiplier: 10.0, unlockThreshold: new Decimal(1000000), requiresPrestige: 3 }
    };

    // --- è¯æ³•åˆ†æå™¨ç±» ---
    /*
        æ˜¯ä»€ä¹ˆ: ä¸€ä¸ªç”¨äºå°†ä»£ç å­—ç¬¦ä¸²åˆ†è§£ä¸ºä¸€ç³»åˆ—â€œä»¤ç‰Œâ€(Token)çš„ç±»ã€‚
        ä¸ºä»€ä¹ˆ: è¿™æ˜¯æ¨¡æ‹Ÿç¼–è¯‘å™¨å·¥ä½œçš„ç¬¬ä¸€æ­¥ã€‚å®ƒå°†åŸå§‹ä»£ç æ–‡æœ¬è½¬åŒ–ä¸ºæœºå™¨æ›´å®¹æ˜“ç†è§£çš„ç»“æ„åŒ–æ•°æ®ã€‚
        å¦‚ä½•å…³è”:
            - è¿™æ˜¯ã€Šç ”ç©¶Level1.mdã€‹1.4.1èŠ‚â€œé˜¶æ®µä¸€ - è¯æ³•åˆ†æâ€å’Œã€Šå®ç°Level1.mdã€‹â€œæ ¸å¿ƒåŠŸèƒ½å®ç°â€ä¸­`Tokenizer`ç±»çš„å…·ä½“å®ç°ã€‚
            - `rules`æ•°ç»„ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰äº†å¦‚ä½•è¯†åˆ«ä»£ç ä¸­çš„ä¸åŒéƒ¨åˆ†ï¼ˆå…³é”®å­—ã€æ•°å­—ã€å­—ç¬¦ä¸²ç­‰ï¼‰ï¼Œæ˜¯è¯æ³•åˆ†æçš„æ ¸å¿ƒè§„åˆ™ã€‚
            - æ¸¸æˆçš„æ ¸å¿ƒç©æ³•ä¹‹ä¸€å°±æ˜¯é€šè¿‡è¿™ä¸ªè¿‡ç¨‹äº§ç”Ÿ`Tokens`èµ„æºã€‚
    */
    class Tokenizer {
        constructor() {
            this.rules = [
                { type: 'KEYWORD', regex: /^(function|var|let|const|if|else|for|while|return|class)\b/ },
                { type: 'NUMBER', regex: /^[0-9]+(\.[0-9]+)?\b/ },
                { type: 'STRING', regex: /^"([^"]*)"|'([^']*)'/ },
                { type: 'IDENTIFIER', regex: /^[a-zA-Z_][a-zA-Z0-9_]*/ },
                { type: 'OPERATOR', regex: /^[+\-*/=<>!&|%]+/ },
                { type: 'DELIMITER', regex: /^[(){}[\];,.]/ },
                { type: 'WHITESPACE', regex: /^\s+/ },
            ];
        }

        tokenize(code) {
            let tokens = [];
            let position = 0;
            while (position < code.length) {
                let match = null;
                for (const rule of this.rules) {
                    const result = rule.regex.exec(code.substring(position));
                    if (result) {
                        match = { type: rule.type, value: result[0], length: result[0].length };
                        break;
                    }
                }
                if (match) {
                    if (match.type !== 'WHITESPACE') tokens.push({ type: match.type, value: match.value });
                    position += match.length;
                } else {
                    tokens.push({ type: 'UNKNOWN', value: code[position] });
                    position++;
                }
            }
            return tokens;
        }
    }

    // --- ç¬¬ä¸‰é˜¶æ®µï¼šä»£ç ç”Ÿæˆå™¨ç±» ---
    /*
        æ˜¯ä»€ä¹ˆ: ä»£ç ç”Ÿæˆå™¨ç±»ï¼Œè´Ÿè´£å°†ASTèŠ‚ç‚¹è½¬æ¢ä¸ºå¯æ‰§è¡Œä»£ç ã€‚
        ä¸ºä»€ä¹ˆ: å®ç°ç¼–è¯‘å™¨çš„ç¬¬ä¸‰ä¸ªæ ¸å¿ƒé˜¶æ®µï¼Œä»æŠ½è±¡è¯­æ³•æ ‘ç”Ÿæˆç›®æ ‡ä»£ç ã€‚
        å¦‚ä½•å…³è”: å¯¹åº”ã€Šç¬¬ä¸‰é˜¶æ®µå®ç°æ–¹æ¡ˆã€‹ä¸­çš„CodeGeneratoræ¶æ„è®¾è®¡ã€‚
    */
    class CodeGenerator {
        constructor() {
            this.templates = {
                basic: { efficiency: 1.0, name: "åŸºç¡€ä»£ç ç”Ÿæˆ" },
                llvm: { efficiency: 1.5, name: "LLVMåç«¯" },
                jit: { efficiency: 2.0, name: "JITç¼–è¯‘å™¨" }
            };
            this.currentTemplate = 'basic';
            this.optimizationLevel = 0;
        }
        
        generateCode(astNodes) {
            const template = this.templates[this.currentTemplate];
            const baseGeneration = astNodes.mul(template.efficiency);
            const optimizationBonus = new Decimal(1).add(this.optimizationLevel * 0.1);
            return baseGeneration.mul(optimizationBonus);
        }
        
        upgradeTemplate(newTemplate) {
            if (this.templates[newTemplate]) {
                this.currentTemplate = newTemplate;
                return true;
            }
            return false;
        }
        
        setOptimizationLevel(level) {
            this.optimizationLevel = level;
        }
    }

    // --- ä»£ç ä¼˜åŒ–å™¨ç±» ---
    /*
        æ˜¯ä»€ä¹ˆ: ä»£ç ä¼˜åŒ–å™¨ç±»ï¼Œå®ç°å„ç§ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ã€‚
        ä¸ºä»€ä¹ˆ: æ¨¡æ‹ŸçœŸå®ç¼–è¯‘å™¨çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œæä¾›ç­–ç•¥æ·±åº¦å’ŒæŠ€æœ¯æ ‘ç©æ³•ã€‚
        å¦‚ä½•å…³è”: å®ç°ã€Šç¬¬ä¸‰é˜¶æ®µå®ç°æ–¹æ¡ˆã€‹ä¸­çš„ä¼˜åŒ–æŠ€æœ¯æ ‘æ¦‚å¿µã€‚
    */
    class CodeOptimizer {
        constructor() {
            this.optimizations = {};
            // åˆå§‹åŒ–ä¼˜åŒ–æŠ€æœ¯
            Object.keys(OPTIMIZATION_TECHS).forEach(key => {
                this.optimizations[key] = {
                    level: 0,
                    cost: OPTIMIZATION_TECHS[key].baseCost
                };
            });
        }
        
        getOptimizationMultiplier() {
            let totalMultiplier = new Decimal(1);
            Object.keys(this.optimizations).forEach(key => {
                const tech = OPTIMIZATION_TECHS[key];
                const level = this.optimizations[key].level;
                const bonus = new Decimal(1).add(level * tech.efficiency);
                totalMultiplier = totalMultiplier.mul(bonus);
            });
            return totalMultiplier;
        }
        
        optimize(generatedCode) {
            return generatedCode.mul(this.getOptimizationMultiplier());
        }
        
        canUpgradeOptimization(techKey, gameState) {
            const tech = OPTIMIZATION_TECHS[techKey];
            const currentData = this.optimizations[techKey];
            
            if (currentData.level >= tech.maxLevel) return false;
            return gameState.resources.generatedCode.gte(currentData.cost);
        }
        
        upgradeOptimization(techKey, gameState) {
            if (!this.canUpgradeOptimization(techKey, gameState)) return false;
            
            const tech = OPTIMIZATION_TECHS[techKey];
            const currentData = this.optimizations[techKey];
            
            gameState.resources.generatedCode = gameState.resources.generatedCode.sub(currentData.cost);
            currentData.level++;
            currentData.cost = tech.baseCost.mul(Decimal.pow(tech.growth, currentData.level));
            
            return true;
        }
    }

    // --- æ€§èƒ½åˆ†æå™¨ç±» ---
    /*
        æ˜¯ä»€ä¹ˆ: æ€§èƒ½åˆ†æå™¨ç±»ï¼Œè¯„ä¼°ä»£ç è´¨é‡å¹¶ç”Ÿæˆæ€§èƒ½åˆ†æ•°ã€‚
        ä¸ºä»€ä¹ˆ: æä¾›ç¬¬ä¸‰é˜¶æ®µçš„æœ€ç»ˆäº§å‡ºæŒ‡æ ‡ï¼Œç”¨äºè§£é”é«˜çº§åŠŸèƒ½ã€‚
        å¦‚ä½•å…³è”: å®ç°ã€Šç¬¬ä¸‰é˜¶æ®µå®ç°æ–¹æ¡ˆã€‹ä¸­çš„æ€§èƒ½åˆ†æç³»ç»Ÿã€‚
    */
    class PerformanceAnalyzer {
        constructor() {
            this.metrics = {
                executionTime: new Decimal(0),
                memoryUsage: new Decimal(0), 
                codeSize: new Decimal(0),
                overallScore: new Decimal(0)
            };
            this.currentPlatform = 'development';
        }
        
        analyzeCode(optimizedCode) {
            const platform = DEPLOYMENT_PLATFORMS[this.currentPlatform];
            const baseScore = optimizedCode.mul(0.1).mul(platform.multiplier);
            
            this.metrics.overallScore = this.metrics.overallScore.add(baseScore);
            this.updateDetailedMetrics(optimizedCode);
            
            return baseScore;
        }
        
        updateDetailedMetrics(optimizedCode) {
            // æ¨¡æ‹Ÿå„ç§æ€§èƒ½æŒ‡æ ‡çš„è®¡ç®—
            const codeQuality = optimizedCode.div(100);
            this.metrics.executionTime = codeQuality.mul(0.8); // è¶Šä¼˜åŒ–æ‰§è¡Œæ—¶é—´è¶ŠçŸ­
            this.metrics.memoryUsage = codeQuality.mul(0.6);
            this.metrics.codeSize = codeQuality.mul(1.2);
        }
        
        deployTo(platform) {
            if (DEPLOYMENT_PLATFORMS[platform] && 
                (DEPLOYMENT_PLATFORMS[platform].unlocked || 
                 this.checkPlatformUnlock(platform))) {
                this.currentPlatform = platform;
                return true;
            }
            return false;
        }
        
        checkPlatformUnlock(platform) {
            const platformData = DEPLOYMENT_PLATFORMS[platform];
            if (platformData.unlockThreshold) {
                return this.metrics.overallScore.gte(platformData.unlockThreshold);
            }
            return true;
        }
        
        getPerformanceRating() {
            const score = this.metrics.overallScore;
            if (score.lt(1000)) return { rating: "åˆçº§", color: "#888888" };
            if (score.lt(10000)) return { rating: "ä¸­çº§", color: "#00ff41" };
            if (score.lt(100000)) return { rating: "é«˜çº§", color: "#00ffff" };
            if (score.lt(1000000)) return { rating: "ä¸“å®¶", color: "#ff0080" };
            return { rating: "å¤§å¸ˆ", color: "#ffd700" };
        }
    }

    // --- æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ ---
    /*
        æ˜¯ä»€ä¹ˆ: ä¸€ä¸ªç®¡ç†æ‰€æœ‰æ¸¸æˆæ ¸å¿ƒæ•°æ®ï¼ˆèµ„æºã€å‡çº§ã€å¨æœ›ç­‰ï¼‰çš„ç±»ï¼Œæ˜¯æ¸¸æˆçš„â€œå¤§è„‘â€ã€‚
        ä¸ºä»€ä¹ˆ: å°†æ‰€æœ‰çŠ¶æ€é›†ä¸­ç®¡ç†ï¼Œå¯ä»¥ä½¿ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼Œæ˜“äºä¿å­˜ã€åŠ è½½å’Œè°ƒè¯•ã€‚è¿™æ˜¯ä¸€ç§å¸¸è§çš„è®¾è®¡æ¨¡å¼ã€‚
        å¦‚ä½•å…³è”: è¿™æ˜¯ã€Šå®ç°Level1.mdã€‹4.4èŠ‚`GameState`ç±»çš„å®ç°ï¼Œæ˜¯æ•´ä¸ªæ¸¸æˆé€»è¾‘çš„ä¸­æ¢ã€‚
    */
    class GameState {
        /*
            æ˜¯ä»€ä¹ˆ: æ¸¸æˆçŠ¶æ€çš„æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æ‰€æœ‰æ ¸å¿ƒæ•°æ®ã€‚
            ä¸ºä»€ä¹ˆ: ç¡®ä¿æ¯æ¬¡æ–°æ¸¸æˆå¼€å§‹æ—¶éƒ½æœ‰ä¸€ä¸ªå¹²å‡€çš„çŠ¶æ€ï¼Œé¿å…æ•°æ®æ±¡æŸ“ã€‚
            å¦‚ä½•å…³è”: ç›´æ¥å®ç°äº†ã€Šå®ç°Level1.mdã€‹4.4èŠ‚ä¸­â€œæ¸¸æˆçŠ¶æ€åˆå§‹åŒ–â€çš„é€»è¾‘ã€‚
        */        constructor() {
            this.gameStartTime = Date.now();
            this.reset(false);
        }

        /*
            æ˜¯ä»€ä¹ˆ: é‡ç½®æ¸¸æˆçŠ¶æ€çš„æ–¹æ³•ï¼Œç”¨äºæ–°æ¸¸æˆå¼€å§‹æˆ–æ‰§è¡Œå¨æœ›ã€‚
            ä¸ºä»€ä¹ˆ: `isPrestige`å‚æ•°å…è®¸åœ¨é‡ç½®æ—¶ä¿ç•™æˆ–å¢åŠ å¨æœ›ç‚¹æ•°ï¼Œè¿™æ˜¯å¨æœ›ç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šç ”ç©¶Level1.mdã€‹2.4èŠ‚â€œå¨æœ›ç³»ç»Ÿâ€çš„é‡ç½®é€»è¾‘ã€‚ä¿ç•™`prestigePoints`æ˜¯â€œæ°¸ä¹…æ€§å¢ç›Šâ€çš„ä½“ç°ã€‚
        */        reset(isPrestige) {
            // å¨æœ›ç³»ç»Ÿå¤„ç†
            if (isPrestige) {
                const newPoints = this.calculatePrestigeGain();
                this.prestige = {
                    compilerPoints: newPoints,
                    totalTokensAllTime: this.prestige.totalTokensAllTime, // ä¿ç•™æ€»è®¡æ•°
                    prestigeCount: this.prestige.prestigeCount + 1,
                    canPrestige: false
                };
            } else {
                this.prestige = {
                    compilerPoints: new Decimal(0),
                    totalTokensAllTime: new Decimal(0),
                    prestigeCount: 0,
                    canPrestige: false
                };
            }            this.resources = { 
                tokens: new Decimal(0), 
                astNodes: new Decimal(0),
                generatedCode: new Decimal(0),
                optimizedCode: new Decimal(0),
                performanceScore: new Decimal(0)
            };
            this.upgrades = {};
            for (const id in UPGRADE_DATA) this.upgrades[id] = { level: 0 };
            
            // åˆå§‹åŒ–ç¬¬ä¸‰é˜¶æ®µå‡çº§
            for (const id in STAGE3_UPGRADES) this.upgrades[id] = { level: 0 };

            this.unlocks = {};
            for (const id in UPGRADE_DATA) {
                if (UPGRADE_DATA[id].unlockThreshold) this.unlocks[id] = false;
            }
            for (const id in STAGE3_UPGRADES) {
                if (STAGE3_UPGRADES[id].unlockThreshold) this.unlocks[id] = false;
            }
            
            if (isPrestige && this.prestige.compilerPoints.gt(0)) {
                this.unlocks.prestige = true; // å¨æœ›åä¿æŒå¨æœ›é¢æ¿å¯è§
            } else {
                this.unlocks.prestige = false;
            }
            
            // åˆå§‹åŒ–ç¬¬ä¸‰é˜¶æ®µç»„ä»¶
            this.codeGenerator = new CodeGenerator();
            this.codeOptimizer = new CodeOptimizer();
            this.performanceAnalyzer = new PerformanceAnalyzer();
        }addResource(type, amount) {
            if (!(amount instanceof Decimal)) amount = new Decimal(amount);
            this.resources[type] = this.resources[type].add(amount);
            if (type === 'tokens') this.prestige.totalTokensAllTime = this.prestige.totalTokensAllTime.add(amount);
        }

        /*
            æ˜¯ä»€ä¹ˆ: ä¿å­˜å’ŒåŠ è½½æ¸¸æˆçŠ¶æ€åˆ°æµè§ˆå™¨çš„localStorageã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯å¢é‡æ¸¸æˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ç©å®¶å…³é—­æµè§ˆå™¨åèƒ½ç»§ç»­ä¹‹å‰çš„è¿›åº¦ï¼Œæ”¯æŒâ€œæ”¾ç½®â€(Idle)ç©æ³•ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­è§„åˆ’çš„å­˜æ¡£åŠŸèƒ½ï¼Œå¹¶å°†æ‰€æœ‰Decimalå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œå­˜å‚¨ã€‚
        */        save() {
            const data = {
                resources: {
                    tokens: this.resources.tokens.toString(),
                    astNodes: this.resources.astNodes.toString(),
                    generatedCode: this.resources.generatedCode.toString(),
                    optimizedCode: this.resources.optimizedCode.toString(),
                    performanceScore: this.resources.performanceScore.toString(),
                },
                upgrades: this.upgrades,
                prestige: {
                    compilerPoints: this.prestige.compilerPoints.toString(),
                    totalTokensAllTime: this.prestige.totalTokensAllTime.toString(),
                    prestigeCount: this.prestige.prestigeCount,
                    canPrestige: this.prestige.canPrestige,
                },
                prestigeUpgrades: PRESTIGE_UPGRADES,
                // ç¬¬ä¸‰é˜¶æ®µæ•°æ®
                stage3: {
                    codeGenerator: {
                        currentTemplate: this.codeGenerator.currentTemplate,
                        optimizationLevel: this.codeGenerator.optimizationLevel
                    },
                    codeOptimizer: this.codeOptimizer.optimizations,
                    performanceAnalyzer: {
                        metrics: {
                            executionTime: this.performanceAnalyzer.metrics.executionTime.toString(),
                            memoryUsage: this.performanceAnalyzer.metrics.memoryUsage.toString(),
                            codeSize: this.performanceAnalyzer.metrics.codeSize.toString(),
                            overallScore: this.performanceAnalyzer.metrics.overallScore.toString()
                        },
                        currentPlatform: this.performanceAnalyzer.currentPlatform
                    }
                },
                unlocks: this.unlocks,
                lastSave: Date.now(),            };
            localStorage.setItem('compilerTycoonSave_v5', JSON.stringify(data));
            
            // è°ƒè¯•æ—¥å¿—ï¼šè®°å½•ä¿å­˜çš„é‡è¦æ•°æ®
            console.log('æ¸¸æˆå·²ä¿å­˜ï¼Œå½“å‰éƒ¨ç½²å¹³å°:', this.performanceAnalyzer.currentPlatform);
        }

        load() {
            const savedData = localStorage.getItem('compilerTycoonSave_v5');
            if (!savedData) return false;

            const data = JSON.parse(savedData);
            this.resources.tokens = new Decimal(data.resources.tokens);
            this.resources.astNodes = new Decimal(data.resources.astNodes);
            
            // åŠ è½½ç¬¬ä¸‰é˜¶æ®µèµ„æº
            if (data.resources.generatedCode) {
                this.resources.generatedCode = new Decimal(data.resources.generatedCode);
                this.resources.optimizedCode = new Decimal(data.resources.optimizedCode);
                this.resources.performanceScore = new Decimal(data.resources.performanceScore);
            }
            
            this.upgrades = data.upgrades;
            
            // ä¿®å¤å¨æœ›æ•°æ®åŠ è½½
            if (data.prestige) {
                this.prestige.compilerPoints = new Decimal(data.prestige.compilerPoints || 0);
                this.prestige.totalTokensAllTime = new Decimal(data.prestige.totalTokensAllTime || 0);
                this.prestige.prestigeCount = data.prestige.prestigeCount || 0;
                this.prestige.canPrestige = data.prestige.canPrestige || false;
            }
            
            // åŠ è½½å¨æœ›å‡çº§æ•°æ®
            if (data.prestigeUpgrades) {
                Object.keys(PRESTIGE_UPGRADES).forEach(key => {
                    if (data.prestigeUpgrades[key]) {
                        PRESTIGE_UPGRADES[key].level = data.prestigeUpgrades[key].level || 0;
                        PRESTIGE_UPGRADES[key].unlocked = data.prestigeUpgrades[key].unlocked || false;
                        PRESTIGE_UPGRADES[key].cost = new Decimal(data.prestigeUpgrades[key].cost || PRESTIGE_UPGRADES[key].baseCost);
                    }
                });
            }
            
            // åŠ è½½ç¬¬ä¸‰é˜¶æ®µæ•°æ®
            if (data.stage3) {
                if (data.stage3.codeGenerator) {
                    this.codeGenerator.currentTemplate = data.stage3.codeGenerator.currentTemplate;
                    this.codeGenerator.optimizationLevel = data.stage3.codeGenerator.optimizationLevel;
                }
                if (data.stage3.codeOptimizer) {
                    Object.keys(data.stage3.codeOptimizer).forEach(key => {
                        if (this.codeOptimizer.optimizations[key]) {
                            this.codeOptimizer.optimizations[key].level = data.stage3.codeOptimizer[key].level || 0;
                            this.codeOptimizer.optimizations[key].cost = new Decimal(data.stage3.codeOptimizer[key].cost || OPTIMIZATION_TECHS[key].baseCost);
                        }
                    });
                }
                if (data.stage3.performanceAnalyzer) {
                    const analyzer = data.stage3.performanceAnalyzer;
                    if (analyzer.metrics) {
                        this.performanceAnalyzer.metrics.executionTime = new Decimal(analyzer.metrics.executionTime || 0);
                        this.performanceAnalyzer.metrics.memoryUsage = new Decimal(analyzer.metrics.memoryUsage || 0);
                        this.performanceAnalyzer.metrics.codeSize = new Decimal(analyzer.metrics.codeSize || 0);
                        this.performanceAnalyzer.metrics.overallScore = new Decimal(analyzer.metrics.overallScore || 0);
                    }                    this.performanceAnalyzer.currentPlatform = analyzer.currentPlatform || 'development';
                    console.log('åŠ è½½çš„éƒ¨ç½²å¹³å°:', this.performanceAnalyzer.currentPlatform);
                }
            }              this.unlocks = { ...this.unlocks, ...data.unlocks };

            // ä¿®å¤ç¦»çº¿æ—¶é—´è®¡ç®—
            const currentTime = Date.now();
            const lastSaveTime = data.lastSave || currentTime;
            const offlineTime = Math.max(0, (currentTime - lastSaveTime) / 1000);
            
            // åªæœ‰ç¦»çº¿è¶…è¿‡30ç§’æ‰æ˜¾ç¤ºç¦»çº¿æ”¶ç›Š
            if (offlineTime >= 30) {
                console.log(`æ£€æµ‹åˆ°ç¦»çº¿æ—¶é—´: ${offlineTime.toFixed(2)}ç§’`);
                this.calculateOfflineGains(offlineTime);
            }
            
            return true;
        }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—ç©å®¶ç¦»çº¿æœŸé—´çš„æ”¶ç›Šã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯â€œæ”¾ç½®æ¸¸æˆâ€çš„å…³é”®ç‰¹æ€§ï¼Œå¥–åŠ±ç©å®¶çš„å›å½’ï¼Œè®©ä»–ä»¬æ„Ÿè§‰å³ä½¿ä¸åœ¨çº¿ï¼Œæ¸¸æˆä¹Ÿåœ¨ä¸ºä»–ä»¬â€œå·¥ä½œâ€ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­è§„åˆ’çš„â€œç¦»çº¿æ”¶ç›Šâ€åŠŸèƒ½ï¼Œæ˜¯ç•™ä½ç©å®¶çš„é‡è¦æœºåˆ¶ã€‚
        */
        calculateOfflineGains(seconds) {
            const production = game.calculateProduction();
            const tokensGained = production.tokens.mul(seconds);
            this.addResource('tokens', tokensGained);

            // ç¦»çº¿æœŸé—´è®¡ç®—ASTèŠ‚ç‚¹çš„è½¬æ¢
            const astGained = production.astNodes.mul(seconds);
            if (this.resources.tokens.gte(astGained)) {
                this.resources.tokens = this.resources.tokens.sub(astGained);
                this.addResource('astNodes', astGained);
            }

            game.UI.showOfflinePopup(tokensGained, seconds);
        }        // æ£€æŸ¥å¨æœ›è§£é”
        checkPrestigeUnlocks() {
            Object.keys(PRESTIGE_UPGRADES).forEach(key => {
                const upgrade = PRESTIGE_UPGRADES[key];
                if (this.prestige.prestigeCount >= upgrade.requiresPrestige && !upgrade.unlocked) {
                    upgrade.unlocked = true;
                    console.log(`å¨æœ›å‡çº§è§£é”: ${upgrade.name}`); // è°ƒè¯•ä¿¡æ¯
                }
            });
        }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—å¨æœ›ç‚¹æ•°å¸¦æ¥çš„ç”Ÿäº§åŠ›åŠ æˆã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯å¨æœ›ç³»ç»Ÿç»™äºˆç©å®¶çš„æ ¸å¿ƒå¥–åŠ±â€”â€”ä¸€ä¸ªå…¨å±€çš„ç”Ÿäº§åŠ›ä¹˜æ•°ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šå®ç°Level1.mdã€‹â€œå¨æœ›æœºåˆ¶â€ä¸­â€œæ‰€æœ‰ç”Ÿäº§é€Ÿåº¦ Ã— (ç¼–è¯‘å™¨ç‚¹æ•° + 1)â€çš„æ•ˆæœï¼ˆè¿™é‡Œæ˜¯+10%æ¯ç‚¹ï¼‰ã€‚
        */
        getPrestigeMultiplier() { return this.prestige.compilerPoints.add(1); }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—å½“å‰å¯ä»¥è·å¾—çš„å¨æœ›ç‚¹æ•°ã€‚
            ä¸ºä»€ä¹ˆ: æ ¹æ®ç©å®¶åœ¨æœ¬è½®æ¸¸æˆä¸­çš„æ€»Tokenäº§é‡æ¥å†³å®šå¨æœ›æ”¶ç›Šï¼Œæ¿€åŠ±ç©å®¶æ¨è¿›æ›´æ·±ã€‚
            å¦‚ä½•å…³è”: ç›´æ¥å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­çš„å¨æœ›å…¬å¼ `prestigeGain = Decimal.sqrt(totalTokens.div(1e6)).floor()`ã€‚
        */
        calculatePrestigeGain() {
            // å…¬å¼ï¼šç¼–è¯‘å™¨ç‚¹æ•° = âˆš(æ€»tokens / 100ä¸‡)
            const threshold = new Decimal(1000000); // 100ä¸‡
            if (this.prestige.totalTokensAllTime.lt(threshold)) {
                return new Decimal(0);
            }
            return Decimal.sqrt(this.prestige.totalTokensAllTime.div(threshold)).floor();
        }

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œå¨æœ›
        checkPrestigeAvailability() {
            const gain = this.calculatePrestigeGain();
            this.prestige.canPrestige = gain.gt(this.prestige.compilerPoints);
            return this.prestige.canPrestige;
        }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—å½“å‰çš„ç”Ÿäº§åŠ›ï¼ˆTokenså’ŒASTèŠ‚ç‚¹ï¼‰ã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯æ¸¸æˆçš„æ ¸å¿ƒå¾ªç¯ï¼Œå†³å®šäº†ç©å®¶æ¯ç§’èƒ½è·å¾—å¤šå°‘èµ„æºã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­â€œç”Ÿäº§åŠ›è®¡ç®—â€çš„é€»è¾‘ï¼Œè€ƒè™‘äº†æ‰€æœ‰å‡çº§å’Œå¨æœ›åŠ æˆã€‚
        */
        performPrestige() {
            if (!this.prestige.canPrestige) return false;
            
            // è®¡ç®—è·å¾—çš„ç¼–è¯‘å™¨ç‚¹æ•°
            const newPoints = this.calculatePrestigeGain();
            const gainedPoints = newPoints.sub(this.prestige.compilerPoints);
            
            // ä¿å­˜å¨æœ›å‰æ•°æ®ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            const prestigeData = {
                gainedPoints: gainedPoints,
                previousTokens: this.resources.tokens,
                timeSpent: Date.now() - this.gameStartTime
            };
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            this.resources.tokens = new Decimal(0);
            this.resources.astNodes = new Decimal(0);
            
            // é‡ç½®å‡çº§ç­‰çº§
            Object.keys(this.upgrades).forEach(key => {
                this.upgrades[key].level = 0;
                this.upgrades[key].cost = this.upgrades[key].baseCost;
            });
            
            // é‡ç½®è§£é”çŠ¶æ€ï¼ˆä½†ä¿ç•™å¨æœ›è§£é”ï¼‰
            this.unlocks.parser = false;
            // ä¸é‡ç½® this.unlocks.prestige
            
            // æ›´æ–°å¨æœ›æ•°æ®
            this.prestige.compilerPoints = newPoints;
            this.prestige.prestigeCount++;
            this.prestige.canPrestige = false;
            
            // æ˜¾ç¤ºå¨æœ›æ”¶ç›Šå¼¹çª—
            this.showPrestigeGainsPopup(prestigeData);
            
            // é‡æ–°è®¡ç®—ç”Ÿäº§åŠ›ï¼ˆåŒ…å«å¨æœ›åŠ æˆï¼‰
            this.calculateProduction();
            
            return true;
        }


        /*
            æ˜¯ä»€ä¹ˆ: æ˜¾ç¤ºå¨æœ›æ”¶ç›Šå¼¹çª—ï¼Œå‘ŠçŸ¥ç©å®¶å¨æœ›é‡ç½®çš„è¯¦ç»†ä¿¡æ¯ã€‚
            ä¸ºä»€ä¹ˆ: æä¾›è§†è§‰åé¦ˆå’Œæˆå°±æ„Ÿï¼Œè®©ç©å®¶æ¸…æ¥šåœ°çœ‹åˆ°å¨æœ›å¸¦æ¥çš„æ”¶ç›Šã€‚
            å¦‚ä½•å…³è”: å®ç°å¨æœ›ç³»ç»Ÿçš„ç”¨æˆ·ä½“éªŒéƒ¨åˆ†ï¼Œå¢å¼ºæ¸¸æˆçš„æ»¡è¶³æ„Ÿã€‚
        */
        showPrestigeGainsPopup(prestigeData) {
            const popup = document.createElement('div');
            popup.className = 'prestige-popup';
            popup.innerHTML = `
                <div class="prestige-popup-content">
                    <h2 class="glitch" data-text="SYSTEM RECOMPILED">SYSTEM RECOMPILED</h2>
                    <div class="prestige-summary">
                        <p>ğŸ”„ å¨æœ›é‡ç½®å®Œæˆ!</p>
                        <p>âš¡ è·å¾—ç¼–è¯‘å™¨ç‚¹æ•°: +${this.formatNumber(prestigeData.gainedPoints)}</p>
                        <p>ğŸ“Š ä¸Šè½®tokensæ€»æ•°: ${this.formatNumber(prestigeData.previousTokens)}</p>
                        <p>â±ï¸ ç”¨æ—¶: ${this.formatTime(prestigeData.timeSpent / 1000)}</p>
                        <p>ğŸš€ å½“å‰ç”Ÿäº§å€æ•°: Ã—${this.formatNumber(this.getPrestigeMultiplier())}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="close-btn">
                        å¼€å§‹æ–°çš„ç¼–è¯‘å¾ªç¯
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
            
            // 5ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 5000);
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆç§’è½¬æ¢ä¸ºåˆ†é’Ÿ:ç§’æ ¼å¼ï¼‰ã€‚
            ä¸ºä»€ä¹ˆ: æä¾›æ›´å‹å¥½çš„æ—¶é—´æ˜¾ç¤ºæ ¼å¼ã€‚
            å¦‚ä½•å…³è”: è¾…åŠ©å¨æœ›å¼¹çª—æ˜¾ç¤ºæ¸¸æˆæ—¶é•¿ã€‚
        */
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—å½“å‰çš„ç”Ÿäº§åŠ›ï¼ˆTokenså’ŒASTèŠ‚ç‚¹ï¼‰ã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯æ¸¸æˆçš„æ ¸å¿ƒå¾ªç¯ï¼Œå†³å®šäº†ç©å®¶æ¯ç§’èƒ½è·å¾—å¤šå°‘èµ„æºã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šå®ç°Level1.mdã€‹ä¸­â€œç”Ÿäº§åŠ›è®¡ç®—â€çš„é€»è¾‘ï¼Œè€ƒè™‘äº†æ‰€æœ‰å‡çº§å’Œå¨æœ›åŠ æˆã€‚
        */        calculateProduction() {
            const prestigeMultiplier = this.getPrestigeMultiplier();
            
            // åŸºç¡€ç”Ÿäº§åŠ› Ã— å¨æœ›å€æ•°
            this.production.tokensPerSecond = new Decimal(this.upgrades.tokenizer.level)
                .mul(1.2)
                .add(this.upgrades.autoTokenizer.level * 5)
                .add(this.upgrades.hyperTokenizer.level * 25)
                .mul(prestigeMultiplier); // å¨æœ›åŠ æˆ
                
            if (this.unlocks.parser) {
                this.production.astNodesPerSecond = new Decimal(this.upgrades.parser.level)
                    .mul(0.8)
                    .mul(prestigeMultiplier); // å¨æœ›åŠ æˆ
            }
            
            // ç¬¬ä¸‰é˜¶æ®µç”Ÿäº§åŠ›è®¡ç®—
            if (this.unlocks.basicCodeGen) {
                // ä»£ç ç”Ÿæˆï¼šASTèŠ‚ç‚¹ â†’ ç”Ÿæˆä»£ç 
                this.production.generatedCodePerSecond = new Decimal(0);
                for (const id in STAGE3_UPGRADES) {
                    const upgrade = this.upgrades[id];
                    if (upgrade && upgrade.level > 0) {
                        const info = STAGE3_UPGRADES[id];
                        if (info.resource === 'generatedCode') {
                            const output = info.baseOutput.mul(upgrade.level).mul(prestigeMultiplier);
                            this.production.generatedCodePerSecond = this.production.generatedCodePerSecond.add(output);
                        }
                    }
                }
                
                // ä»£ç ä¼˜åŒ–ï¼šç”Ÿæˆä»£ç  â†’ ä¼˜åŒ–ä»£ç 
                if (this.production.generatedCodePerSecond && this.production.generatedCodePerSecond.gt(0)) {
                    const optimizationMultiplier = this.codeOptimizer.getOptimizationMultiplier();
                    this.production.optimizedCodePerSecond = this.production.generatedCodePerSecond
                        .mul(0.1) // åŸºç¡€è½¬æ¢ç‡
                        .mul(optimizationMultiplier);
                }
                
                // æ€§èƒ½åˆ†æ•°ï¼šä¼˜åŒ–ä»£ç  â†’ æ€§èƒ½åˆ†æ•°
                if (this.production.optimizedCodePerSecond && this.production.optimizedCodePerSecond.gt(0)) {
                    const platformMultiplier = DEPLOYMENT_PLATFORMS[this.performanceAnalyzer.currentPlatform].multiplier;
                    this.production.performanceScorePerSecond = this.production.optimizedCodePerSecond
                        .mul(0.1) // åŸºç¡€è½¬æ¢ç‡
                        .mul(platformMultiplier);
                }
            }
        }
    }

    // --- UI ä¸ å¯è§†åŒ– ---
    /*
        æ˜¯ä»€ä¹ˆ: ä¸€ä¸ªä¸“é—¨è´Ÿè´£æ›´æ–°ç”¨æˆ·ç•Œé¢(UI)æ‰€æœ‰éƒ¨åˆ†çš„ç±»ã€‚
        ä¸ºä»€ä¹ˆ: å°†UIæ›´æ–°é€»è¾‘ä¸æ¸¸æˆæ ¸å¿ƒé€»è¾‘(GameState)åˆ†ç¦»ï¼Œè¿™æ˜¯ä¸€ç§è‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œç§°ä¸ºâ€œå…³æ³¨ç‚¹åˆ†ç¦»â€ï¼Œä½¿ä»£ç æ›´æ˜“äºç»´æŠ¤ã€‚
        å¦‚ä½•å…³è”: è¿™ä¸ªç±»è´Ÿè´£å°†`GameState`ä¸­çš„æ•°æ®æ¸²æŸ“åˆ°ã€Šå®ç°Level1.mdã€‹ä¸­è®¾è®¡çš„â€œä»ªè¡¨ç›˜å¸ƒå±€â€çš„å„ä¸ªHTMLå…ƒç´ ä¸Šã€‚
    */
    class UIUpdater {        constructor() {
            this.elements = {
                statsContainer: document.getElementById('stats-container'),
                upgradesContainer: document.getElementById('upgrades-container'),
                tokenStream: document.getElementById('token-stream'),
                prestigePanel: document.getElementById('prestige-panel'),
                prestigeGain: document.getElementById('prestige-gain-display'),
                // ç¬¬ä¸‰é˜¶æ®µå…ƒç´ 
                stage3Panel: document.getElementById('stage3-panel'),
                codeGenProgress: document.getElementById('code-gen-progress'),
                generatorType: document.getElementById('generator-type'),
                generatedCodeCount: document.getElementById('generated-code-count'),
                optimizationTechs: document.getElementById('optimization-techs'),
                executionTimeGauge: document.getElementById('execution-time-gauge'),
                memoryEfficiencyGauge: document.getElementById('memory-efficiency-gauge'),
                performanceRating: document.getElementById('performance-rating'),
                performanceScore: document.getElementById('performance-score'),
                deploymentPlatforms: document.getElementById('deployment-platforms')
            };
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ ¼å¼åŒ–å¤§æ•°å­—ä»¥ä¾¿äºé˜…è¯»ã€‚
            ä¸ºä»€ä¹ˆ: 1000000 ä¸å¦‚ 1.00M ç›´è§‚ã€‚è¿™ç§æ ¼å¼åŒ–æ˜¯å¢é‡æ¸¸æˆUIçš„æ ‡é…ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šå®ç°Level1.md`GameState`ç±»ä¸­çš„`formatNumber`åŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
        */
        formatNumber(num) {
            if (num.lt(1e3)) return num.toDP(1).toFixed();
            if (num.lt(1e6)) return num.div(1e3).toDP(2) + 'K';
            if (num.lt(1e9)) return num.div(1e6).toDP(2) + 'M';
            if (num.lt(1e12)) return num.div(1e9).toDP(2) + 'B';
            return num.toExponential(2);
        }        updateStats(state, production) {
            const prestigeBonus = (state.getPrestigeMultiplier().sub(1)).mul(100);
            const isParserUnlocked = state.unlocks['auto-parser-1'];
            const isStage3Unlocked = state.unlocks['basicCodeGen'];
            
            let statsData = [
                { label: 'Tokens', value: this.formatNumber(state.resources.tokens), color: 'var(--accent-green)' },
                { label: 'Tokens/s', value: `+${this.formatNumber(production.tokens)}`, color: 'text-green-400' }
            ];
            
            if (isParserUnlocked) {
                statsData.push(
                    { label: 'AST Nodes', value: this.formatNumber(state.resources.astNodes), color: 'var(--accent-cyan)' },
                    { label: 'AST Nodes/s', value: `+${this.formatNumber(production.astNodes)}`, color: 'text-cyan-400' }
                );
            }
            
            if (isStage3Unlocked) {
                statsData.push(
                    { label: 'ç”Ÿæˆä»£ç ', value: this.formatNumber(state.resources.generatedCode), color: 'text-purple-400' },
                    { label: 'ä¼˜åŒ–ä»£ç ', value: this.formatNumber(state.resources.optimizedCode), color: 'text-orange-400' },
                    { label: 'æ€§èƒ½åˆ†æ•°', value: this.formatNumber(state.resources.performanceScore), color: 'text-yellow-400' }
                );
            }
            
            statsData.push(
                { label: 'ç¼–è¯‘å™¨ç‚¹æ•°', value: state.prestige.compilerPoints.toFixed(), color: 'text-yellow-400' },
                { label: 'å¨æœ›åŠ æˆ', value: `+${prestigeBonus.toFixed(1)}%`, color: 'text-yellow-400' }
            );
            
            const statsHTML = statsData.map(stat => `
                <div class="stat-item">
                    <p class="text-sm text-gray-400 mb-1">${stat.label}</p>
                    <p class="text-xl font-bold" style="color: ${stat.color};">${stat.value}</p>
                </div>
            `).join('');
            
            this.elements.statsContainer.innerHTML = statsHTML;
        }        updateUpgrades(state) {
            this.elements.upgradesContainer.innerHTML = '';
            
            // æ™®é€šå‡çº§
            for (const id in UPGRADE_DATA) {
                const info = UPGRADE_DATA[id];
                if (info.unlockThreshold && !state.unlocks[id]) continue;

                const upgradeState = state.upgrades[id];
                const costResource = info.costResource || 'tokens';
                
                // è®¡ç®—æ‰¹é‡è´­ä¹°çš„æ€»æˆæœ¬
                const totalCost = game.calculateBulkCost(info.baseCost, info.growth, upgradeState.level, game.buyAmount);
                const canAfford = state.resources[costResource].gte(totalCost);

                // æ˜¾ç¤ºæ–‡æœ¬ï¼šx1æ—¶æ˜¾ç¤ºå•ä¸ªï¼Œx10/x100æ—¶æ˜¾ç¤ºæ‰¹é‡
                const buttonText = game.buyAmount === 1 ? 
                    `å‡çº§ (${this.formatNumber(totalCost)} ${costResource})` :
                    `å‡çº§ x${game.buyAmount} (${this.formatNumber(totalCost)} ${costResource})`;

                const div = document.createElement('div');
                div.className = 'hacker-box p-4 border border-transparent transition-all';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">${info.name}</h3>
                        <span class="text-md font-bold text-gray-400">Lv. ${upgradeState.level}</span>
                    </div>
                    <p class="text-sm text-gray-400 mt-1 mb-3">${info.description}</p>
                    <button class="w-full btn btn-primary" ${canAfford ? '' : 'disabled'} onclick="game.buyUpgrade('${id}')">
                        ${buttonText}
                    </button>
                `;
                this.elements.upgradesContainer.appendChild(div);
            }
              // ç¬¬ä¸‰é˜¶æ®µå‡çº§
            if (state.unlocks.basicCodeGen) {
                for (const id in STAGE3_UPGRADES) {
                    const info = STAGE3_UPGRADES[id];
                    if (info.unlockThreshold && !state.unlocks[id]) continue;

                    const upgradeState = state.upgrades[id];
                    const costResource = info.costResource || 'astNodes';
                    
                    // è®¡ç®—æ‰¹é‡è´­ä¹°çš„æ€»æˆæœ¬
                    const totalCost = game.calculateBulkCost(info.baseCost, info.growth, upgradeState.level, game.buyAmount);
                    const canAfford = state.resources[costResource].gte(totalCost);

                    // æ˜¾ç¤ºæ–‡æœ¬ï¼šx1æ—¶æ˜¾ç¤ºå•ä¸ªï¼Œx10/x100æ—¶æ˜¾ç¤ºæ‰¹é‡
                    const buttonText = game.buyAmount === 1 ? 
                        `å‡çº§ (${this.formatNumber(totalCost)} ${costResource})` :
                        `å‡çº§ x${game.buyAmount} (${this.formatNumber(totalCost)} ${costResource})`;

                    const div = document.createElement('div');
                    div.className = 'hacker-box p-4 border border-transparent transition-all bg-gradient-to-r from-purple-800 to-indigo-800';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-purple-300">ğŸ”§ ${info.name}</h3>
                            <span class="text-md font-bold text-purple-400">Lv. ${upgradeState.level}</span>
                        </div>
                        <p class="text-sm text-purple-200 mt-1 mb-3">${info.description}</p>
                        <button class="w-full btn btn-secondary" ${canAfford ? '' : 'disabled'} onclick="game.buyStage3Upgrade('${id}')">
                            ${buttonText}
                        </button>
                    `;
                    this.elements.upgradesContainer.appendChild(div);
                }
            }
            
            // å¨æœ›å‡çº§
            if (state.unlocks.prestige) {
                for (const id in PRESTIGE_UPGRADES) {
                    const info = PRESTIGE_UPGRADES[id];
                    if (!info.unlocked) continue;

                    const costResource = 'compilerPoints';
                    const cost = info.baseCost.times(Decimal.pow(1.5, info.level)); // å¨æœ›å‡çº§æˆé•¿ç‡
                    const canAfford = state.prestige.compilerPoints.gte(cost);

                    const div = document.createElement('div');
                    div.className = 'hacker-box p-4 border border-transparent transition-all bg-gradient-to-r from-purple-900 to-blue-900';
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-yellow-300">âš¡ ${info.name}</h3>
                            <span class="text-md font-bold text-yellow-400">Lv. ${info.level}</span>
                        </div>
                        <p class="text-sm text-gray-300 mt-1 mb-3">${info.effect}</p>
                        <button class="w-full btn btn-secondary" ${canAfford ? '' : 'disabled'} onclick="game.buyPrestigeUpgrade('${id}')">
                            å‡çº§ (æˆæœ¬: ${this.formatNumber(cost)} ç¼–è¯‘å™¨ç‚¹æ•°)
                        </button>
                    `;
                    this.elements.upgradesContainer.appendChild(div);
                }
            }
        }        updatePrestige(state) {
            if (state.unlocks.prestige) {
                this.elements.prestigePanel.style.display = 'block';
                const currentGain = state.calculatePrestigeGain();
                const newGain = currentGain.sub(state.prestige.compilerPoints);
                this.elements.prestigeGain.textContent = newGain.toFixed();
                
                // æ›´æ–°å¨æœ›æŒ‰é’®çŠ¶æ€
                const prestigeBtn = document.getElementById('prestige-btn');
                if (state.prestige.canPrestige && newGain.gt(0)) {
                    prestigeBtn.disabled = false;
                    prestigeBtn.textContent = `æ‰§è¡Œé‡æ„ (+${newGain.toFixed()} ç¼–è¯‘å™¨ç‚¹æ•°)`;
                } else {
                    prestigeBtn.disabled = true;
                    prestigeBtn.textContent = 'æ‰§è¡Œé‡æ„ (éœ€è¦æ›´å¤štokens)';
                }
            } else {
                this.elements.prestigePanel.style.display = 'none';
            }
        }        /*
            æ˜¯ä»€ä¹ˆ: æ›´æ–°ç¬¬ä¸‰é˜¶æ®µä¸“å±UIé¢æ¿ã€‚
            ä¸ºä»€ä¹ˆ: ä¸ºç¬¬ä¸‰é˜¶æ®µçš„å¤æ‚åŠŸèƒ½æä¾›ä¸“é—¨çš„ç”¨æˆ·ç•Œé¢æ›´æ–°ã€‚
            å¦‚ä½•å…³è”: å®ç°ç¬¬ä¸‰é˜¶æ®µUI/UXè®¾è®¡çš„æ ¸å¿ƒå±•ç¤ºé€»è¾‘ã€‚
        */        updateStage3Panels(state) {
            const stage3Tab = document.getElementById('stage3-tab');
            const stage3TabContent = document.getElementById('stage3-tab-content');
            
            // æ£€æŸ¥ç¬¬ä¸‰é˜¶æ®µæ˜¯å¦è§£é”
            const isUnlocked = state.unlocks.basicCodeGen;
            
            if (!isUnlocked) {
                if (stage3Tab) stage3Tab.style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºç¬¬ä¸‰é˜¶æ®µæ ‡ç­¾
            if (stage3Tab) stage3Tab.style.display = 'block';

            // æ›´æ–°ä»£ç ç”Ÿæˆå™¨ç±»å‹æ˜¾ç¤º
            if (this.elements.generatorType) {
                const template = state.codeGenerator.templates[state.codeGenerator.currentTemplate];
                this.elements.generatorType.textContent = template.name;
            }

            // æ›´æ–°ç”Ÿæˆä»£ç è®¡æ•°
            if (this.elements.generatedCodeCount) {
                this.elements.generatedCodeCount.textContent = this.formatNumber(state.resources.generatedCode);
            }

            // æ›´æ–°ASTèŠ‚ç‚¹æ˜¾ç¤ºï¼ˆä»£ç ç”Ÿæˆçš„è¾“å…¥ï¼‰
            const astDisplay = document.querySelector('.input-section .resource-flow');
            if (astDisplay) {
                astDisplay.innerHTML = `ğŸ“Š ${this.formatNumber(state.resources.astNodes)}`;
            }

            // æ›´æ–°ä»£ç ç”Ÿæˆè¿›åº¦æ¡
            if (this.elements.codeGenProgress) {
                const progress = Math.min(100, state.resources.astNodes.div(100).toNumber());
                this.elements.codeGenProgress.style.width = `${progress}%`;
            }

            // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
            if (this.elements.performanceScore) {
                this.elements.performanceScore.textContent = this.formatNumber(state.resources.performanceScore) + ' åˆ†';
            }

            // æ›´æ–°æ€§èƒ½è¯„çº§
            if (this.elements.performanceRating) {
                const score = state.performanceAnalyzer.metrics.overallScore;
                let rating = 'F';
                let color = 'text-red-400';
                if (score.gte(10000)) { rating = 'S+'; color = 'text-yellow-400'; }
                else if (score.gte(5000)) { rating = 'S'; color = 'text-orange-400'; }
                else if (score.gte(1000)) { rating = 'A'; color = 'text-green-400'; }
                else if (score.gte(500)) { rating = 'B'; color = 'text-blue-400'; }
                else if (score.gte(100)) { rating = 'C'; color = 'text-cyan-400'; }
                else if (score.gte(10)) { rating = 'D'; color = 'text-gray-400'; }
                
                this.elements.performanceRating.className = `text-3xl font-bold ${color} performance-rating`;
                this.elements.performanceRating.textContent = rating;
            }

            // æ›´æ–°ä¼˜åŒ–æŠ€æœ¯æŒ‰é’®
            this.updateOptimizationTechs(state);
            
            // æ›´æ–°éƒ¨ç½²å¹³å°æŒ‰é’®
            this.updateDeploymentPlatforms(state);

            console.log('ç¬¬ä¸‰é˜¶æ®µé¢æ¿å·²æ›´æ–°', {
                unlocked: isUnlocked,
                generatedCode: state.resources.generatedCode.toString(),
                astNodes: state.resources.astNodes.toString()
            });
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ›´æ–°ä¼˜åŒ–æŠ€æœ¯æ ‘çš„UIã€‚
            ä¸ºä»€ä¹ˆ: å±•ç¤ºå¯ç”¨çš„ä¼˜åŒ–æŠ€æœ¯åŠå…¶å‡çº§çŠ¶æ€ã€‚
        */        updateOptimizationTechs(state) {
            if (!this.elements.optimizationTechs) return;

            this.elements.optimizationTechs.innerHTML = '';
            
            Object.keys(OPTIMIZATION_TECHS).forEach(key => {
                const tech = OPTIMIZATION_TECHS[key];
                const currentData = state.codeOptimizer.optimizations[key];
                
                // è®¡ç®—èƒ½å¤Ÿè´­ä¹°çš„æ•°é‡ï¼ˆä¸è¶…è¿‡æ‰¹é‡è´­ä¹°è®¾ç½®å’Œå‰©ä½™å¯è´­ä¹°ç­‰çº§ï¼‰
                const maxLevels = tech.maxLevel - currentData.level;
                const actualAmount = Math.min(game.buyAmount, maxLevels);
                
                // è®¡ç®—æ‰¹é‡è´­ä¹°çš„æ€»æˆæœ¬
                let totalCost = new Decimal(0);
                let tempLevel = currentData.level;
                for (let i = 0; i < actualAmount; i++) {
                    const levelCost = tech.baseCost.mul(Decimal.pow(tech.growth, tempLevel));
                    totalCost = totalCost.plus(levelCost);
                    tempLevel++;
                }
                
                const canAfford = actualAmount > 0 && state.resources.generatedCode.gte(totalCost);
                
                // æ˜¾ç¤ºæ–‡æœ¬ï¼šx1æ—¶æ˜¾ç¤ºå•ä¸ªï¼Œx10/x100æ—¶æ˜¾ç¤ºæ‰¹é‡
                const buttonText = actualAmount === 1 ? 
                    this.formatNumber(totalCost) :
                    `x${actualAmount} (${this.formatNumber(totalCost)})`;

                const div = document.createElement('div');
                div.className = 'optimization-tech p-3 border border-gray-600 rounded-lg bg-gray-800 hover:bg-gray-700 transition-all';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-orange-300">${tech.name}</h4>
                        <span class="text-sm text-orange-400">Lv.${currentData.level}/${tech.maxLevel}</span>
                    </div>
                    <p class="text-xs text-gray-300 mb-2">${tech.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-green-400">+${(tech.efficiency * 100).toFixed(1)}%æ•ˆç‡</span>
                        <button class="btn-mini ${canAfford ? 'bg-orange-600 hover:bg-orange-500' : 'bg-gray-600 cursor-not-allowed'}" 
                                ${canAfford ? '' : 'disabled'} 
                                onclick="game.buyOptimization('${key}')">
                            ${buttonText}
                        </button>
                    </div>
                `;
                this.elements.optimizationTechs.appendChild(div);
            });
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ›´æ–°éƒ¨ç½²å¹³å°çš„UIã€‚
            ä¸ºä»€ä¹ˆ: å±•ç¤ºå¯ç”¨çš„éƒ¨ç½²å¹³å°åŠå…¶æ€§èƒ½å€æ•°ã€‚
        */
        updateDeploymentPlatforms(state) {
            if (!this.elements.deploymentPlatforms) return;

            this.elements.deploymentPlatforms.innerHTML = '';
            
            Object.keys(DEPLOYMENT_PLATFORMS).forEach(key => {
                const platform = DEPLOYMENT_PLATFORMS[key];
                const isActive = state.performanceAnalyzer.currentPlatform === key;
                const isUnlocked = platform.unlocked || state.performanceAnalyzer.checkPlatformUnlock(key);

                const div = document.createElement('div');
                div.className = `deployment-platform p-3 border rounded-lg transition-all cursor-pointer ${
                    isActive ? 'border-cyan-400 bg-cyan-900' : 
                    isUnlocked ? 'border-gray-600 bg-gray-800 hover:bg-gray-700' : 
                    'border-gray-700 bg-gray-900 opacity-50'
                }`;
                
                if (isUnlocked) {
                    div.onclick = () => game.switchDeploymentPlatform(key);
                }

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <h4 class="font-bold ${isActive ? 'text-cyan-300' : 'text-white'}">${platform.name}</h4>
                        ${isActive ? '<span class="text-xs text-cyan-400">å½“å‰</span>' : ''}
                    </div>
                    <p class="text-xs text-gray-300 mb-2">${platform.description}</p>
                    <div class="text-sm">
                        <span class="text-green-400">Ã—${platform.multiplier} æ€§èƒ½å€æ•°</span>
                        ${platform.unlockThreshold ? 
                            `<div class="text-xs text-yellow-400 mt-1">éœ€è¦: ${this.formatNumber(platform.unlockThreshold)} æ€§èƒ½åˆ†æ•°</div>` : 
                            ''
                        }
                    </div>
                `;
                this.elements.deploymentPlatforms.appendChild(div);
            });
        }

        /*
            æ˜¯ä»€ä¹ˆ: å°†è¯æ³•åˆ†æå™¨ç”Ÿæˆçš„ä»¤ç‰Œæ•°ç»„æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚
            ä¸ºä»€ä¹ˆ: ä¸ºç©å®¶æä¾›å³æ—¶ã€ç”ŸåŠ¨çš„è§†è§‰åé¦ˆï¼Œè®©ä»–ä»¬çœ‹åˆ°è‡ªå·±çš„â€œç‚¹å‡»â€æ“ä½œï¼ˆè¯æ³•åˆ†æï¼‰äº§ç”Ÿäº†å…·ä½“çš„ç»“æœã€‚
            å¦‚ä½•å…³è”: è¿™æ˜¯ã€Šå®ç°Level1.mdã€‹ä¸­â€œé˜¶æ®µä¸€ï¼šè¯æ³•åˆ†æâ€é‡Œâ€œå¯è§†åŒ–ï¼šä»£ç å­—ç¬¦ä¸²é€ä¸ªåˆ†è§£ä¸ºå½©è‰²tokenå—â€çš„æ ¸å¿ƒå®ç°ã€‚
        */
        displayTokens(tokens) {
            this.elements.tokenStream.innerHTML = '';
            tokens.forEach((token, index) => {
                const span = document.createElement('span');
                span.className = `token token-${token.type}`;
                span.textContent = token.value;
                span.style.animationDelay = `${index * 20}ms`;
                this.elements.tokenStream.appendChild(span);
            });
        }        showOfflinePopup(gains, seconds) {
            // ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„ç¦»çº¿æ—¶é—´
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            
            const div = document.createElement('div');
            div.className = 'offline-popup fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50';
            div.innerHTML = `
                <div class="hacker-box p-8 text-center popup-content">
                    <h3 class="text-2xl font-bold glitch" data-text="æ¬¢è¿å›æ¥!">æ¬¢è¿å›æ¥!</h3>
                    <p class="my-4">æ‚¨ç¦»çº¿äº† ${minutes} åˆ†é’Ÿ ${remainingSeconds} ç§’</p>
                    <p class="mb-6">ç¼–è¯‘å™¨ä¸ºæ‚¨è·å¾—äº† <span class="font-bold text-green-400">${this.formatNumber(gains)}</span> Tokens!</p>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">é¢†å–</button>
                </div>
            `;
            document.body.appendChild(div);
            
            // è°ƒè¯•æ—¥å¿—
            console.log(`ç¦»çº¿æ”¶ç›Šè®¡ç®—: ${seconds.toFixed(2)}ç§’ = ${minutes}åˆ†${remainingSeconds}ç§’, è·å¾—${this.formatNumber(gains)} Tokens`);
        }
    }

    // --- æŠ½è±¡è¯­æ³•æ ‘(AST) å¯è§†åŒ–å™¨ ---
    /*
        æ˜¯ä»€ä¹ˆ: ä½¿ç”¨D3.jsåº“æ¥åŠ¨æ€ç”Ÿæˆå’Œæ¸²æŸ“æŠ½è±¡è¯­æ³•æ ‘çš„ç±»ã€‚
        ä¸ºä»€ä¹ˆ: è¿™æ˜¯æ¸¸æˆè¿›å…¥ç¬¬äºŒé˜¶æ®µâ€œè¯­æ³•åˆ†æâ€çš„æ ¸å¿ƒè§†è§‰è¡¨ç°ã€‚å®ƒå°†æ— å½¢çš„â€œASTèŠ‚ç‚¹â€èµ„æºè½¬åŒ–ä¸ºç©å®¶å¯è§çš„ã€ä¸æ–­æˆé•¿çš„æ ‘çŠ¶ç»“æ„ã€‚
        å¦‚ä½•å…³è”:
            - è¿™æ˜¯ã€Šå®ç°Level1.mdã€‹ä¸­â€œé˜¶æ®µäºŒï¼šè¯­æ³•åˆ†æâ€å’Œâ€œASTå¯è§†åŒ– (ä½¿ç”¨D3.js)â€åŠŸèƒ½çš„ä»£ç å®ç°ã€‚
            - å®ƒå°†æ¸¸æˆçš„è¿›ç¨‹ï¼ˆASTèŠ‚ç‚¹æ•°é‡ï¼‰ä¸ä¸€ä¸ªå¤æ‚çš„ã€æœ‰ä¸»é¢˜æ·±åº¦çš„å¯è§†åŒ–ç›´æ¥å…³è”èµ·æ¥ï¼Œå¼ºåŒ–äº†â€œæ„å»ºç¼–è¯‘å™¨â€çš„æ²‰æµ¸æ„Ÿã€‚
    */
    class ASTVisualizer {
        constructor(containerId) {
            this.container = d3.select(`#${containerId}`);
            this.svg = this.container.append("svg").attr("width", "100%").attr("height", "100%");
            this.treeLayout = d3.tree();
            this.rootNode = null;
        }

        // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ã€ç”¨äºæ¼”ç¤ºçš„å‡æ•°æ®ç”Ÿæˆå™¨ã€‚åœ¨çœŸå®ç¼–è¯‘å™¨ä¸­ï¼ŒASTç”±è§£æå™¨æ ¹æ®ä»£ç ç»“æ„ç”Ÿæˆã€‚
        generateTreeData(nodeCount) {
            if (nodeCount <= 0) return null;
            const root = { name: "Program", children: [] };
            let queue = [root];
            let count = 1;

            while (count < nodeCount && queue.length > 0) {
                let current = queue.shift();
                if (!current.children) current.children = [];

                let childrenCount = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < childrenCount && count < nodeCount; i++) {
                    const child = { name: `Node_${count}` };
                    current.children.push(child);
                    queue.push(child);
                    count++;
                }
            }
            return root;
        }

        update(astNodeCount) {
            // å°†ASTèŠ‚ç‚¹æ•°é‡é€šè¿‡å¯¹æ•°å…³ç³»æ˜ å°„åˆ°å¯è§†åŒ–çš„èŠ‚ç‚¹æ•°ï¼Œä»¥æ§åˆ¶è§†è§‰ä¸Šçš„å¤æ‚åº¦ï¼Œé¿å…èŠ‚ç‚¹è¿‡å¤šå¯¼è‡´å¡é¡¿ã€‚
            const nodeCount = Math.floor(astNodeCount.add(1).log(10).times(10).toNumber());
            const treeData = this.generateTreeData(nodeCount);

            const { width, height } = this.container.node().getBoundingClientRect();
            this.treeLayout.size([width, height - 40]);

            this.svg.selectAll("*").remove();

            if (!treeData) {
                this.svg.append("text").attr("x", "50%").attr("y", "50%").attr("text-anchor", "middle").style("fill", "#8b949e").text("å‡çº§è§£æå™¨ä»¥æ„å»ºAST...");
                return;
            }

            this.rootNode = d3.hierarchy(treeData);
            this.treeLayout(this.rootNode);

            const g = this.svg.append('g').attr('transform', 'translate(0, 20)');

            g.selectAll('path.link').data(this.rootNode.links()).enter().append('path')
                .style('fill', 'none').style('stroke', '#30363d').style('stroke-width', '1.5px')
                .attr('d', d3.linkVertical().x(d => d.x).y(d => d.y))
                .style('opacity', 0).transition().duration(500).style('opacity', 1);

            const nodes = g.selectAll('g.node').data(this.rootNode.descendants()).enter().append('g')
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .style('opacity', 0);

            nodes.append('circle').attr('r', 5).style('fill', '#161b22').style('stroke', '#39c5fe').style('stroke-width', '2px');

            nodes.append('text')
                .text(d => d.data.name)
                .attr('text-anchor', 'middle')
                .attr('dy', '-0.8em')
                .style('font-size', '11px')
                .style('fill', '#c9d1d9');

            nodes.transition().duration(500).delay((d,i) => i * 15).style('opacity', 1);
        }
    }

    // --- æ€§èƒ½å›¾è¡¨ ---
    /*
        æ˜¯ä»€ä¹ˆ: ä½¿ç”¨Chart.jsåº“æ¥åˆ›å»ºå’Œæ›´æ–°å®æ—¶æ€§èƒ½å›¾è¡¨çš„ç±»ã€‚
        ä¸ºä»€ä¹ˆ: ä¸ºç©å®¶æä¾›å…³äºä»–ä»¬â€œè‡ªåŠ¨åŒ–å¼•æ“â€æ•ˆç‡çš„ç›´è§‚æ•°æ®åé¦ˆï¼Œè®©ä»–ä»¬èƒ½æ¸…æ™°åœ°çœ‹åˆ°æ¯æ¬¡å‡çº§å¸¦æ¥çš„æ€§èƒ½æå‡ã€‚
        å¦‚ä½•å…³è”:
            - è¿™æ˜¯ã€Šå®ç°Level1.mdã€‹ä¸­â€œæ€§èƒ½å›¾è¡¨ (ä½¿ç”¨Chart.js)â€åŠŸèƒ½çš„ä»£ç å®ç°ã€‚
            - å›¾è¡¨è¿½è¸ªå¹¶æ˜¾ç¤ºâ€œTokens/sâ€å’Œâ€œAST Nodes/sâ€ï¼Œç›´æ¥å¯¹åº”äº†ã€Šç ”ç©¶Level1.md`3.3.2èŠ‚ä¸­ä»ªè¡¨ç›˜éœ€è¦è¿½è¸ªçš„æ ¸å¿ƒæŒ‡æ ‡ã€‚
    */
    class PerformanceChart {
        constructor(canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const textColor = '#c9d1d9';
            const gridColor = '#30363d';

            this.chart = new Chart(ctx, {
                type: 'line', data: { labels: [], datasets: [
                        { label: 'Tokens/s', data: [], borderColor: '#23d18b', backgroundColor: 'rgba(35, 209, 139, 0.1)', tension: 0.4, yAxisID: 'y' },
                        { label: 'AST Nodes/s', data: [], borderColor: '#39c5fe', backgroundColor: 'rgba(57, 197, 254, 0.1)', tension: 0.4, yAxisID: 'y1' }
                    ]},
                options: { responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                        y1: { position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, ticks: { color: textColor } },
                        x: { grid: { color: gridColor }, ticks: { color: textColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 7 } }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                }
            });
        }
        update(production) {
            const now = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            this.chart.data.labels.push(now);
            this.chart.data.datasets[0].data.push(production.tokens.toNumber());
            this.chart.data.datasets[1].data.push(production.astNodes.toNumber());
            if (this.chart.data.labels.length > 20) {
                this.chart.data.labels.shift();
                this.chart.data.datasets.forEach(ds => ds.data.shift());
            }
            this.chart.update('none');
        }
    }

    // --- ä¸»æ¸¸æˆæ§åˆ¶å™¨ ---
    /*
        æ˜¯ä»€ä¹ˆ: æ¸¸æˆçš„æ€»æ§åˆ¶å™¨ï¼Œè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—ã€ç®¡ç†æ¸¸æˆä¸»å¾ªç¯å’Œå¤„ç†ç©å®¶è¾“å…¥ã€‚
        ä¸ºä»€ä¹ˆ: ä½œä¸ºç¨‹åºçš„å…¥å£ç‚¹å’Œåè°ƒè€…ï¼Œå°†æ‰€æœ‰å­ç³»ç»Ÿï¼ˆçŠ¶æ€ã€UIã€åˆ†è¯å™¨ç­‰ï¼‰ä¸²è”èµ·æ¥å·¥ä½œã€‚
        å¦‚ä½•å…³è”: è¿™æ˜¯æ•´ä¸ªæ¸¸æˆé€»è¾‘çš„â€œmainâ€å‡½æ•°ï¼Œæ‰§è¡Œäº†ã€Šå®ç°Level1.mdã€‹ä¸­å®šä¹‰çš„å¼€å‘é‡Œç¨‹ç¢‘ä¸­çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ã€‚
    */
    class Game {        constructor() {
            this.state = new GameState();
            this.UI = new UIUpdater();
            this.tokenizer = new Tokenizer();
            this.ast = null;
            this.chart = null;
            this.editor = null;
            this.lastTick = performance.now();
            this.devMode = false; // å¼€å‘è€…æ¨¡å¼æ ‡å¿—
            this.buyAmount = 1; // è´­ä¹°æ•°é‡ï¼š1, 10, 100
        }init() {
            // åˆå§‹åŒ–å›¾è¡¨å’ŒASTå¯è§†åŒ–
            this.chart = new PerformanceChart('performance-chart');
            this.ast = new ASTVisualizer('ast-visualization');

            if (!this.state.load()) {
                console.log("No save file found, starting new game.");
            } else {
                console.log("Save file loaded.");
            }

            // åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
            this.initTabSystem();

            document.getElementById('run-lexer-btn').addEventListener('click', () => this.runLexer());
            document.getElementById('prestige-btn').addEventListener('click', () => this.prestige());
            
            // å¼€å‘è€…åé—¨ - é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                // Ctrl + Shift + D æ¿€æ´»å¼€å‘è€…æ¨¡å¼
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    this.toggleDevMode();
                }
                
                // å¼€å‘è€…å¿«æ·é”®ï¼ˆéœ€è¦å…ˆæ¿€æ´»å¼€å‘è€…æ¨¡å¼ï¼‰
                if (this.devMode) {
                    switch(e.key) {
                        case '1': // è·å¾—100ä¸‡tokens
                            this.state.addResource('tokens', new Decimal(1000000));
                            console.log('ğŸ® DEV: æ·»åŠ äº†100ä¸‡tokens');
                            break;
                        case '2': // è·å¾—1000ä¸‡tokens
                            this.state.addResource('tokens', new Decimal(10000000));
                            console.log('ğŸ® DEV: æ·»åŠ äº†1000ä¸‡tokens');
                            break;
                        case '3': // è·å¾—100ç¼–è¯‘å™¨ç‚¹æ•°
                            this.state.prestige.compilerPoints = this.state.prestige.compilerPoints.add(100);
                            console.log('ğŸ® DEV: æ·»åŠ äº†100ç¼–è¯‘å™¨ç‚¹æ•°');
                            break;
                        case '4': // è§£é”æ‰€æœ‰å‡çº§
                            Object.keys(this.state.unlocks).forEach(key => {
                                this.state.unlocks[key] = true;
                            });
                            console.log('ğŸ® DEV: è§£é”äº†æ‰€æœ‰å‡çº§');
                            break;                        case '5': // æ¨¡æ‹Ÿå¨æœ›æ¬¡æ•°
                            this.state.prestige.prestigeCount += 5;
                            this.state.checkPrestigeUnlocks();
                            console.log('ğŸ® DEV: å¢åŠ äº†5æ¬¡å¨æœ›æ¬¡æ•°');
                            break;
                        case '6': // å¿«é€Ÿè§£é”ç¬¬ä¸‰é˜¶æ®µ
                            this.state.addResource('astNodes', new Decimal(1000000));
                            this.state.unlocks.basicCodeGen = true;
                            this.state.unlocks.llvmCodeGen = true;
                            this.state.unlocks.jitCodeGen = true;
                            console.log('ğŸ® DEV: è§£é”ç¬¬ä¸‰é˜¶æ®µå¹¶æ·»åŠ 100ä¸‡ASTèŠ‚ç‚¹');
                            break;
                        case '7': // æ·»åŠ ç¬¬ä¸‰é˜¶æ®µèµ„æº
                            this.state.addResource('generatedCode', new Decimal(100000));
                            this.state.addResource('optimizedCode', new Decimal(10000));
                            this.state.addResource('performanceScore', new Decimal(1000));
                            console.log('ğŸ® DEV: æ·»åŠ ç¬¬ä¸‰é˜¶æ®µèµ„æº');
                            break;
                        case '0': // é‡ç½®æ¸¸æˆ
                            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿ')) {
                                localStorage.removeItem('compilerTycoonSave_v4');
                                location.reload();
                            }
                            break;
                    }
                }
            });

            // å¯åŠ¨æ¸¸æˆå¾ªç¯å’Œå®šæ—¶æ›´æ–°
            requestAnimationFrame((t) => this.gameLoop(t)); // é«˜é¢‘å¾ªç¯ï¼Œç”¨äºå¹³æ»‘çš„èµ„æºå¢é•¿
            setInterval(() => this.slowUpdate(), 250); // ä¸­é¢‘å¾ªç¯ï¼Œç”¨äºæ›´æ–°UIå’Œè§£é”æ£€æŸ¥
            setInterval(() => this.state.save(), 15000); // ä½é¢‘å¾ªç¯ï¼Œç”¨äºè‡ªåŠ¨ä¿å­˜
            setInterval(() => { // å¯è§†åŒ–æ›´æ–°å¾ªç¯
                if (document.visibilityState === 'visible') {
                    const production = this.calculateProduction();
                    this.chart.update(production);
                    if (this.state.unlocks['auto-parser-1']) {
                        this.ast.update(this.state.resources.astNodes);
                    }
                }
            }, 2000);
        }        /*
            æ˜¯ä»€ä¹ˆ: åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢ç³»ç»Ÿã€‚
            ä¸ºä»€ä¹ˆ: æä¾›æ›´å¥½çš„UIç»„ç»‡å’Œç”¨æˆ·ä½“éªŒã€‚
        */
        initTabSystem() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabPanels.forEach(p => {
                        p.classList.remove('active');
                        p.style.display = 'none';
                    });
                    
                    // è®¾ç½®å½“å‰æ´»åŠ¨çŠ¶æ€
                    btn.classList.add('active');
                    
                    // æ ¹æ®data-tabå±æ€§æŸ¥æ‰¾å¯¹åº”çš„é¢æ¿
                    let targetPanel = null;
                    if (targetTab === 'upgrades') {
                        targetPanel = document.getElementById('upgrades-tab');
                    } else if (targetTab === 'analytics') {
                        targetPanel = document.getElementById('analytics-tab');
                    } else if (targetTab === 'stage3') {
                        targetPanel = document.getElementById('stage3-tab-content');
                    } else if (targetTab === 'lexer') {
                        targetPanel = document.getElementById('lexer-tab');
                    }
                    
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        targetPanel.style.display = 'block';
                        console.log(`åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ: ${targetTab}`);
                    } else {
                        console.error(`æ‰¾ä¸åˆ°æ ‡ç­¾é¡µé¢æ¿: ${targetTab}`);
                    }
                });
            });
            
            // é»˜è®¤æ¿€æ´»å‡çº§æ ‡ç­¾é¡µ
            const defaultTab = document.querySelector('.tab-btn[data-tab="upgrades"]');
            const defaultPanel = document.getElementById('upgrades-tab');
            if (defaultTab && defaultPanel) {
                defaultTab.classList.add('active');
                defaultPanel.classList.add('active');
                defaultPanel.style.display = 'block';
            }
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ¸¸æˆçš„ä¸»å¾ªç¯ï¼Œä»¥æµè§ˆå™¨çš„åˆ·æ–°ç‡ï¼ˆé€šå¸¸60fpsï¼‰è¿è¡Œã€‚
            ä¸ºä»€ä¹ˆ: è´Ÿè´£è®¡ç®—è‡ªä¸Šä¸€å¸§ä»¥æ¥ç»è¿‡çš„æ—¶é—´(delta)ï¼Œå¹¶æ ¹æ®è¿™ä¸ªæ—¶é—´å·®æ¥å¢åŠ èµ„æºã€‚è¿™ç¡®ä¿äº†æ— è®ºå¸§ç‡å¦‚ä½•å˜åŒ–ï¼Œèµ„æºçš„å¢é•¿é€Ÿåº¦éƒ½æ˜¯æ’å®šçš„ã€å¹³æ»‘çš„ã€‚
            å¦‚ä½•å…³è”: è¿™æ˜¯å¢é‡æ¸¸æˆçš„â€œå¿ƒè·³â€ï¼Œå®ç°äº†ã€Šç ”ç©¶Level1.mdã€‹3.2.2èŠ‚ä¸­æè¿°çš„â€œæ¸¸æˆä¸»å¾ªç¯â€é€»è¾‘ï¼Œæ˜¯æ‰€æœ‰è‡ªåŠ¨åŒ–ç”Ÿäº§çš„åŸºç¡€ã€‚
        */        gameLoop(timestamp) {
            const delta = (timestamp - this.lastTick) / 1000;
            this.lastTick = timestamp;

            const production = this.calculateProduction();
            this.state.addResource('tokens', production.tokens.mul(delta));

            // ASTèŠ‚ç‚¹çš„ç”Ÿäº§æ¶ˆè€—Tokens
            const astProduction = production.astNodes.mul(delta);
            if (this.state.resources.tokens.gte(astProduction)) {
                this.state.resources.tokens = this.state.resources.tokens.sub(astProduction);
                this.state.addResource('astNodes', astProduction);
            }

            // ç¬¬ä¸‰é˜¶æ®µç”Ÿäº§é“¾
            if (this.state.unlocks.basicCodeGen) {
                // ä»£ç ç”Ÿæˆï¼šASTèŠ‚ç‚¹ â†’ ç”Ÿæˆä»£ç 
                const generatedCodeProduction = production.generatedCode ? production.generatedCode.mul(delta) : new Decimal(0);
                if (this.state.resources.astNodes.gte(generatedCodeProduction)) {
                    this.state.resources.astNodes = this.state.resources.astNodes.sub(generatedCodeProduction);
                    this.state.addResource('generatedCode', generatedCodeProduction);
                }

                // ä»£ç ä¼˜åŒ–ï¼šç”Ÿæˆä»£ç  â†’ ä¼˜åŒ–ä»£ç 
                const optimizedCodeProduction = production.optimizedCode ? production.optimizedCode.mul(delta) : new Decimal(0);
                if (this.state.resources.generatedCode.gte(optimizedCodeProduction)) {
                    this.state.resources.generatedCode = this.state.resources.generatedCode.sub(optimizedCodeProduction);
                    this.state.addResource('optimizedCode', optimizedCodeProduction);
                }

                // æ€§èƒ½åˆ†æï¼šä¼˜åŒ–ä»£ç  â†’ æ€§èƒ½åˆ†æ•°
                const performanceProduction = production.performanceScore ? production.performanceScore.mul(delta) : new Decimal(0);
                if (this.state.resources.optimizedCode.gte(performanceProduction)) {
                    this.state.resources.optimizedCode = this.state.resources.optimizedCode.sub(performanceProduction);
                    this.state.addResource('performanceScore', performanceProduction);
                    
                    // åŒæ—¶æ›´æ–°æ€§èƒ½åˆ†æå™¨çš„æŒ‡æ ‡
                    this.state.performanceAnalyzer.analyzeCode(performanceProduction);
                }
            }

            // åªæ›´æ–°æœ€å…³é”®çš„æ•°å­—ç»Ÿè®¡ï¼Œé¿å…æ€§èƒ½æŸè€—
            this.UI.updateStats(this.state, production);

            requestAnimationFrame((t) => this.gameLoop(t));
        }

        /*
            æ˜¯ä»€ä¹ˆ: ä¸€ä¸ªè¾ƒæ…¢çš„æ›´æ–°å¾ªç¯ã€‚
            ä¸ºä»€ä¹ˆ: åƒå‡çº§æŒ‰é’®çŠ¶æ€è¿™ç±»UIä¸éœ€è¦æ¯ç§’æ›´æ–°60æ¬¡ã€‚å°†å®ƒä»¬æ”¾åœ¨ä¸€ä¸ªè¾ƒæ…¢çš„å¾ªç¯é‡Œå¯ä»¥èŠ‚çœè®¡ç®—èµ„æºï¼Œæé«˜æ€§èƒ½ã€‚
            å¦‚ä½•å…³è”: è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ¸¸æˆå¼€å‘ä¼˜åŒ–æŠ€å·§ï¼Œå¹³è¡¡äº†UIçš„å“åº”é€Ÿåº¦å’Œç³»ç»Ÿæ€§èƒ½ã€‚
        */        slowUpdate() {
            this.checkUnlocks();
            this.UI.updateUpgrades(this.state);
            this.UI.updatePrestige(this.state);
            this.UI.updateStage3Panels(this.state);
            
            // æ£€æŸ¥å¨æœ›å¯ç”¨æ€§
            if (this.state.unlocks.prestige) {
                this.state.checkPrestigeAvailability();
                this.state.checkPrestigeUnlocks();
            }
        }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—å½“å‰æ¯ç§’çš„èµ„æºäº§å‡ºé‡ã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯æ¸¸æˆè‡ªåŠ¨åŒ–å¼•æ“çš„æ ¸å¿ƒè®¡ç®—é€»è¾‘ã€‚å®ƒæ±‡æ€»æ‰€æœ‰å·²è´­ä¹°çš„è‡ªåŠ¨åŒ–å‡çº§çš„æ•ˆæœï¼Œå¹¶è®¡å…¥å¨æœ›åŠ æˆã€‚
            å¦‚ä½•å…³è”:
                - å®ç°äº†ã€Šå®ç°Level1.md`ä¸­çš„â€œåŸºç¡€ç”Ÿäº§å…¬å¼â€å’Œâ€œå¨æœ›ç³»ç»Ÿâ€çš„åŠ æˆæ•ˆæœã€‚
                - `totalOutput = info.baseOutput.mul(upgrade.level).mul(prestigeMultiplier)` è¿™è¡Œä»£ç æ˜¯æ•´ä¸ªæ¸¸æˆç»æµç³»ç»Ÿçš„æ ¸å¿ƒï¼Œä½“ç°äº†çº¿æ€§å¢é•¿ï¼ˆä¹˜ä»¥levelï¼‰å’Œå…¨å±€ä¹˜æ•°ï¼ˆå¨æœ›ï¼‰çš„ç»“åˆã€‚
        */        calculateProduction() {
            const prestigeMultiplier = this.state.getPrestigeMultiplier();
            let production = { 
                tokens: new Decimal(0), 
                astNodes: new Decimal(0),
                generatedCode: new Decimal(0),
                optimizedCode: new Decimal(0),
                performanceScore: new Decimal(0)
            };

            // å¤„ç†å‰ä¸¤é˜¶æ®µå‡çº§
            for (const id in this.state.upgrades) {
                const upgrade = this.state.upgrades[id];
                const info = UPGRADE_DATA[id] || STAGE3_UPGRADES[id];
                if (!info || upgrade.level === 0 || info.type === 'manual') continue;

                let totalOutput = info.baseOutput.mul(upgrade.level).mul(prestigeMultiplier);
                
                // å¨æœ›å‡çº§æ•ˆæœ
                if (PRESTIGE_UPGRADES.quantumTokenizer.level > 0 && info.resource === 'tokens') {
                    totalOutput = totalOutput.mul(1 + PRESTIGE_UPGRADES.quantumTokenizer.level * 4); // æ¯çº§+400%
                }
                if (PRESTIGE_UPGRADES.parallelCompiler.level > 0) {
                    totalOutput = totalOutput.mul(1 + PRESTIGE_UPGRADES.parallelCompiler.level * 1); // æ¯çº§+100%
                }
                if (PRESTIGE_UPGRADES.aiOptimizer.level > 0) {
                    totalOutput = totalOutput.mul(1 + PRESTIGE_UPGRADES.aiOptimizer.level * 2); // æ¯çº§+200%
                }

                if (info.type === 'generator') {
                    production[info.resource] = production[info.resource].add(totalOutput);
                } else if (info.type === 'converter') {
                    production[info.resource] = production[info.resource].add(totalOutput);
                }
            }

            // ç¬¬ä¸‰é˜¶æ®µç‰¹æ®Šç”Ÿäº§è®¡ç®—
            if (this.state.unlocks.basicCodeGen) {
                // ä»£ç ä¼˜åŒ–å€æ•°åº”ç”¨
                const optimizationMultiplier = this.state.codeOptimizer.getOptimizationMultiplier();
                if (production.generatedCode.gt(0)) {
                    production.optimizedCode = production.generatedCode.mul(0.1).mul(optimizationMultiplier);
                }

                // æ€§èƒ½åˆ†æå¹³å°å€æ•°åº”ç”¨
                const platformMultiplier = DEPLOYMENT_PLATFORMS[this.state.performanceAnalyzer.currentPlatform].multiplier;
                if (production.optimizedCode.gt(0)) {
                    production.performanceScore = production.optimizedCode.mul(0.1).mul(platformMultiplier);
                }
            }

            return production;
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ£€æŸ¥æ˜¯å¦æ»¡è¶³è§£é”æ–°åŠŸèƒ½æˆ–æ–°å‡çº§çš„æ¡ä»¶ã€‚
            ä¸ºä»€ä¹ˆ: æ§åˆ¶æ¸¸æˆèŠ‚å¥ï¼Œé€æ­¥å‘ç©å®¶å¼•å…¥æ–°æœºåˆ¶ï¼Œé¿å…ä¿¡æ¯è¿‡è½½ã€‚
            å¦‚ä½•å…³è”: è¿™æ˜¯ã€Šç ”ç©¶Level1.md`1.4èŠ‚ä¸­æåˆ°çš„â€œå±•å¼€å¼è®¾è®¡â€çš„å…·ä½“å®ç°ï¼Œæ˜¯å¼•å¯¼ç©å®¶ã€ä¿æŒé•¿æœŸå¸å¼•åŠ›çš„å…³é”®ã€‚
        */        checkUnlocks() {
            const tokenCount = this.state.prestige.totalTokensAllTime;
            const astNodeCount = this.state.resources.astNodes;
            
            // æ£€æŸ¥å‰ä¸¤é˜¶æ®µè§£é”
            for (const id in UPGRADE_DATA) {
                const info = UPGRADE_DATA[id];
                if (info.unlockThreshold && !this.state.unlocks[id]) {
                    if (tokenCount.gte(info.unlockThreshold)) {
                        this.state.unlocks[id] = true;
                    }
                }
            }

            // æ£€æŸ¥ç¬¬ä¸‰é˜¶æ®µè§£é”
            for (const id in STAGE3_UPGRADES) {
                const info = STAGE3_UPGRADES[id];
                if (info.unlockThreshold && !this.state.unlocks[id]) {
                    if (astNodeCount.gte(info.unlockThreshold)) {
                        this.state.unlocks[id] = true;
                        console.log(`ç¬¬ä¸‰é˜¶æ®µè§£é”: ${info.name}`);
                    }
                }
            }

            // å¨æœ›è§£é”
            if (!this.state.unlocks.prestige && tokenCount.gte(1e6)) {
                this.state.unlocks.prestige = true;
            }
        }

        /*
            æ˜¯ä»€ä¹ˆ: ç©å®¶æ‰‹åŠ¨æ‰§è¡Œè¯æ³•åˆ†æçš„æ“ä½œã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯æ¸¸æˆåˆæœŸçš„ä¸»è¦äº’åŠ¨æ–¹å¼ï¼Œæ„æˆäº†â€œè¡ŒåŠ¨ -> èµ„æºâ€çš„æ ¸å¿ƒå¾ªç¯ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šç ”ç©¶Level1.md`1.1èŠ‚â€œåŸå§‹å¾ªç¯â€ä¸­çš„â€œè¡ŒåŠ¨â€éƒ¨åˆ†ã€‚ç©å®¶é€šè¿‡è¿™ä¸ªæ“ä½œè·å¾—ç¬¬ä¸€æ‰¹èµ„æºï¼ˆTokensï¼‰ã€‚
        */        runLexer() {
            const code = document.getElementById('code-input').value || `function hello() {
    return "Hello World!";
}`;
            const tokens = this.tokenizer.tokenize(code);
            this.UI.displayTokens(tokens);

            const manualUpgrade = this.state.upgrades['token-speed'];
            const baseGain = new Decimal(tokens.length);
            const bonus = baseGain.mul(UPGRADE_DATA['token-speed'].baseOutput).mul(manualUpgrade.level);
            const totalGain = baseGain.add(bonus);

            this.state.addResource('tokens', totalGain);
        }

        /*
            æ˜¯ä»€ä¹ˆ: å¤„ç†è´­ä¹°å‡çº§çš„é€»è¾‘ã€‚
            ä¸ºä»€ä¹ˆ: è¿™æ˜¯â€œèµ„æº -> å‡çº§â€çš„æ ¸å¿ƒå¾ªç¯ï¼Œç©å®¶æ¶ˆè€—èµ„æºæ¥å¢å¼ºä»–ä»¬çš„ç”Ÿäº§èƒ½åŠ›ã€‚
            å¦‚ä½•å…³è”:
                - å®ç°äº†ã€Šç ”ç©¶Level1.md`1.1èŠ‚â€œåŸå§‹å¾ªç¯â€ä¸­çš„â€œå‡çº§â€éƒ¨åˆ†ã€‚
                - æˆæœ¬è®¡ç®— `cost = info.baseCost.times(Decimal.pow(info.growth, upgradeState.level))` æ˜¯â€œæŒ‡æ•°å¢é•¿â€æˆæœ¬å…¬å¼çš„ç›´æ¥åº”ç”¨ã€‚
        */        /*
            æ˜¯ä»€ä¹ˆ: è®¾ç½®è´­ä¹°æ•°é‡ã€‚
            ä¸ºä»€ä¹ˆ: å…è®¸ç©å®¶é€‰æ‹©ä¸€æ¬¡è´­ä¹°1ä¸ªã€10ä¸ªæˆ–100ä¸ªå‡çº§ï¼Œæé«˜åæœŸæ¸¸æˆæ•ˆç‡ã€‚
        */
        setBuyAmount(amount) {
            this.buyAmount = amount;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.buy-amount-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.getAttribute('data-amount')) === amount) {
                    btn.classList.add('active');
                }
            });
        }

        /*
            æ˜¯ä»€ä¹ˆ: è®¡ç®—æ‰¹é‡è´­ä¹°çš„æ€»æˆæœ¬ã€‚
            ä¸ºä»€ä¹ˆ: å¤„ç†æŒ‡æ•°å¢é•¿çš„æˆæœ¬è®¡ç®—ï¼Œç¡®ä¿æ‰¹é‡è´­ä¹°çš„å‡†ç¡®æ€§ã€‚
        */
        calculateBulkCost(baseCost, growth, currentLevel, amount) {
            let totalCost = new Decimal(0);
            for (let i = 0; i < amount; i++) {
                const levelCost = baseCost.times(Decimal.pow(growth, currentLevel + i));
                totalCost = totalCost.add(levelCost);
            }
            return totalCost;
        }

        buyUpgrade(id) {
            const info = UPGRADE_DATA[id];
            const upgradeState = this.state.upgrades[id];
            const costResource = info.costResource || 'tokens';
            
            // è®¡ç®—æ‰¹é‡è´­ä¹°çš„æ€»æˆæœ¬
            const totalCost = this.calculateBulkCost(info.baseCost, info.growth, upgradeState.level, this.buyAmount);
            
            if (this.state.resources[costResource].gte(totalCost)) {
                this.state.resources[costResource] = this.state.resources[costResource].sub(totalCost);
                upgradeState.level += this.buyAmount;
            }
        }/*
            æ˜¯ä»€ä¹ˆ: è´­ä¹°å¨æœ›ä¸“å±å‡çº§çš„æ–¹æ³•ã€‚
            ä¸ºä»€ä¹ˆ: å¨æœ›å‡çº§ä½¿ç”¨ç¼–è¯‘å™¨ç‚¹æ•°ä½œä¸ºè´§å¸ï¼Œæä¾›å¼ºåŠ›çš„æ°¸ä¹…æ€§åŠ æˆã€‚
            å¦‚ä½•å…³è”: å®ç°å¨æœ›ç³»ç»Ÿçš„æ·±åº¦å†…å®¹ï¼Œç»™ç©å®¶æ›´å¤šé•¿æœŸç›®æ ‡ã€‚
        */
        buyPrestigeUpgrade(id) {
            const info = PRESTIGE_UPGRADES[id];
            const cost = info.baseCost.times(Decimal.pow(1.5, info.level));

            if (this.state.prestige.compilerPoints.gte(cost)) {
                this.state.prestige.compilerPoints = this.state.prestige.compilerPoints.sub(cost);
                info.level++;
                info.cost = info.baseCost.times(Decimal.pow(1.5, info.level));
            }
        }        /*
            æ˜¯ä»€ä¹ˆ: è´­ä¹°ç¬¬ä¸‰é˜¶æ®µå‡çº§çš„æ–¹æ³•ï¼ˆæ”¯æŒæ‰¹é‡è´­ä¹°ï¼‰ã€‚
            ä¸ºä»€ä¹ˆ: å¤„ç†ä»£ç ç”Ÿæˆç›¸å…³çš„å‡çº§è´­ä¹°ï¼Œä½¿ç”¨ASTèŠ‚ç‚¹ä½œä¸ºè´§å¸ï¼Œæ”¯æŒx1/x10/x100æ‰¹é‡è´­ä¹°ã€‚
            å¦‚ä½•å…³è”: å®ç°ç¬¬ä¸‰é˜¶æ®µçš„æ ¸å¿ƒäº¤äº’å¾ªç¯ã€‚
        */
        buyStage3Upgrade(id) {
            const info = STAGE3_UPGRADES[id];
            const upgradeState = this.state.upgrades[id];
            const costResource = info.costResource || 'astNodes';
            const totalCost = this.calculateBulkCost(info.baseCost, info.growth, upgradeState.level, this.buyAmount);

            if (this.state.resources[costResource].gte(totalCost)) {
                this.state.resources[costResource] = this.state.resources[costResource].sub(totalCost);
                upgradeState.level += this.buyAmount;
                
                // ç‰¹æ®Šå¤„ç†ï¼šæ›´æ–°ä»£ç ç”Ÿæˆå™¨æ¨¡æ¿
                if (id === 'llvmCodeGen') {
                    this.state.codeGenerator.upgradeTemplate('llvm');
                } else if (id === 'jitCodeGen') {
                    this.state.codeGenerator.upgradeTemplate('jit');
                }
            }
        }        /*
            æ˜¯ä»€ä¹ˆ: è´­ä¹°ä¼˜åŒ–æŠ€æœ¯å‡çº§ï¼ˆæ”¯æŒæ‰¹é‡è´­ä¹°ï¼‰ã€‚
            ä¸ºä»€ä¹ˆ: å…è®¸ç©å®¶æŠ•èµ„äºå„ç§ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯ï¼Œæå‡ä»£ç è´¨é‡ï¼Œæ”¯æŒx1/x10/x100æ‰¹é‡è´­ä¹°ã€‚
            å¦‚ä½•å…³è”: å®ç°ç¬¬ä¸‰é˜¶æ®µä¼˜åŒ–æŠ€æœ¯æ ‘çš„æ ¸å¿ƒäº¤äº’ã€‚
        */
        buyOptimization(techKey) {
            const tech = OPTIMIZATION_TECHS[techKey];
            const currentData = this.state.codeOptimizer.optimizations[techKey];
            
            // è®¡ç®—èƒ½å¤Ÿè´­ä¹°çš„æ•°é‡ï¼ˆä¸è¶…è¿‡æ‰¹é‡è´­ä¹°è®¾ç½®å’Œå‰©ä½™å¯è´­ä¹°ç­‰çº§ï¼‰
            const maxLevels = tech.maxLevel - currentData.level;
            const actualAmount = Math.min(this.buyAmount, maxLevels);
            
            if (actualAmount <= 0) return;
            
            // è®¡ç®—æ‰¹é‡è´­ä¹°çš„æ€»æˆæœ¬
            let totalCost = new Decimal(0);
            let tempLevel = currentData.level;
            for (let i = 0; i < actualAmount; i++) {
                const levelCost = tech.baseCost.mul(Decimal.pow(tech.growth, tempLevel));
                totalCost = totalCost.plus(levelCost);
                tempLevel++;
            }
              if (this.state.resources.generatedCode.gte(totalCost)) {
                this.state.resources.generatedCode = this.state.resources.generatedCode.sub(totalCost);
                currentData.level += actualAmount;
                currentData.cost = tech.baseCost.mul(Decimal.pow(tech.growth, currentData.level));
                console.log(`ä¼˜åŒ–æŠ€æœ¯å‡çº§: ${tech.name} (+${actualAmount}çº§)`);
                
                // ç«‹å³ä¿å­˜ä¼˜åŒ–æŠ€æœ¯å‡çº§
                this.state.save();
            }
        }        /*
            æ˜¯ä»€ä¹ˆ: åˆ‡æ¢éƒ¨ç½²å¹³å°ã€‚
            ä¸ºä»€ä¹ˆ: å…è®¸ç©å®¶é€‰æ‹©ä¸åŒçš„éƒ¨ç½²ç¯å¢ƒä»¥è·å¾—ä¸åŒçš„æ€§èƒ½å€æ•°ã€‚
            å¦‚ä½•å…³è”: å®ç°ç¬¬ä¸‰é˜¶æ®µæ€§èƒ½åˆ†æç³»ç»Ÿçš„å¹³å°ç®¡ç†ã€‚
        */
        switchDeploymentPlatform(platform) {
            if (this.state.performanceAnalyzer.deployTo(platform)) {
                console.log(`åˆ‡æ¢åˆ°éƒ¨ç½²å¹³å°: ${DEPLOYMENT_PLATFORMS[platform].name}`);
                // é‡æ–°è®¡ç®—ç”Ÿäº§åŠ›ä»¥åº”ç”¨æ–°å¹³å°å€æ•°
                this.calculateProduction();
                // ç«‹å³ä¿å­˜ä»¥ç¡®ä¿å¹³å°åˆ‡æ¢è¢«è®°å½•
                this.state.save();
                console.log(`éƒ¨ç½²å¹³å°å·²åˆ‡æ¢ä¸º: ${platform}, å¹¶å·²ä¿å­˜`);
            }
        }

        /*
            æ˜¯ä»€ä¹ˆ: æ‰§è¡Œå¨æœ›é‡ç½®ã€‚
            ä¸ºä»€ä¹ˆ: å…è®¸ç©å®¶é‡ç½®æ¸¸æˆä»¥æ¢å–æ°¸ä¹…æ€§åŠ æˆï¼Œè¿™æ˜¯åº”å¯¹åæœŸæ¸¸æˆè¿›ç¨‹æ”¾ç¼“ã€æä¾›é•¿æœŸç›®æ ‡çš„ç»å…¸å¢é‡æ¸¸æˆæœºåˆ¶ã€‚
            å¦‚ä½•å…³è”: å®ç°äº†ã€Šç ”ç©¶Level1.md`2.4èŠ‚å’Œã€Šå®ç°Level1.md`â€œå¨æœ›ç³»ç»Ÿè®¾è®¡â€ä¸­å®šä¹‰çš„å®Œæ•´å¨æœ›å¾ªç¯ï¼šæ£€æŸ¥æ”¶ç›Šã€ç¡®è®¤ã€é‡ç½®çŠ¶æ€ã€ä¿å­˜ã€‚
        */
        prestige() {
            const gain = this.state.calculatePrestigeGain();
            if (gain.gt(0)) {                // åœ¨çœŸå®æ¸¸æˆä¸­ï¼Œåº”è¯¥ä½¿ç”¨è‡ªå®šä¹‰çš„æ¨¡æ€æ¡†(modal)æ›¿ä»£confirm()ï¼Œä»¥è·å¾—æ›´å¥½çš„æ ·å¼å’Œç”¨æˆ·ä½“éªŒã€‚
                if(confirm(`æ‚¨ç¡®å®šè¦é‡æ„ç¼–è¯‘å™¨å—ï¼Ÿ\n\nè¿™å°†é‡ç½®æ‚¨å½“å‰çš„å‡çº§å’Œèµ„æºï¼Œä»¥æ¢å– ${gain.toFixed()} ä¸ªæ°¸ä¹…æ€§çš„ç¼–è¯‘å™¨ç‚¹æ•°åŠ æˆã€‚`)){
                    this.state.performPrestige();
                    this.state.save();
                    this.ast.update(new Decimal(0));
                }
            }
        }

        /*
            å¼€å‘è€…åé—¨æ–¹æ³•
        */
        toggleDevMode() {
            this.devMode = !this.devMode;
            if (this.devMode) {
                console.log('ğŸ® å¼€å‘è€…æ¨¡å¼å·²æ¿€æ´»ï¼');                
                console.log('ğŸ® å¿«æ·é”®ï¼š');
                console.log('ğŸ®   1 - è·å¾—100ä¸‡tokens');
                console.log('ğŸ®   2 - è·å¾—1000ä¸‡tokens');
                console.log('ğŸ®   3 - è·å¾—100ç¼–è¯‘å™¨ç‚¹æ•°');
                console.log('ğŸ®   4 - è§£é”æ‰€æœ‰å‡çº§');
                console.log('ğŸ®   5 - å¢åŠ 5æ¬¡å¨æœ›æ¬¡æ•°');
                console.log('ğŸ®   6 - å¿«é€Ÿè§£é”ç¬¬ä¸‰é˜¶æ®µ');
                console.log('ğŸ®   7 - æ·»åŠ ç¬¬ä¸‰é˜¶æ®µèµ„æº');
                console.log('ğŸ®   0 - é‡ç½®æ¸¸æˆ');
                
                // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå¼€å‘è€…æ¨¡å¼æŒ‡ç¤ºå™¨
                if (!document.getElementById('dev-indicator')) {
                    const indicator = document.createElement('div');
                    indicator.id = 'dev-indicator';
                    indicator.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: linear-gradient(45deg, #ff0000, #ff6600);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-family: monospace;
                        font-size: 12px;
                        z-index: 9999;
                        box-shadow: 0 0 10px rgba(255,0,0,0.5);
                        animation: pulse 2s infinite;
                    `;
                    indicator.textContent = 'ğŸ® DEV MODE';
                    document.body.appendChild(indicator);
                    
                    // æ·»åŠ è„‰å†²åŠ¨ç”»
                    if (!document.getElementById('dev-style')) {
                        const style = document.createElement('style');
                        style.id = 'dev-style';
                        style.textContent = `
                            @keyframes pulse {
                                0%, 100% { opacity: 1; transform: scale(1); }
                                50% { opacity: 0.7; transform: scale(1.05); }
                            }
                        `;
                        document.head.appendChild(style);
                    }
                }
            } else {
                console.log('ğŸ® å¼€å‘è€…æ¨¡å¼å·²å…³é—­');
                const indicator = document.getElementById('dev-indicator');
                if (indicator) indicator.remove();
            }
        }
    }

    // --- å¯åŠ¨æ¸¸æˆ ---
    /*
        æ˜¯ä»€ä¹ˆ: æ¸¸æˆå¯åŠ¨å…¥å£ã€‚
        ä¸ºä»€ä¹ˆ: ä½¿ç”¨ `window.onload` ç¡®ä¿åœ¨æ‰€æœ‰HTMLå…ƒç´ å’Œèµ„æºéƒ½åŠ è½½å®Œæ¯•åæ‰å¼€å§‹æ‰§è¡Œæ¸¸æˆåˆå§‹åŒ–é€»è¾‘ï¼Œé¿å…å› å…ƒç´ æœªæ‰¾åˆ°è€Œäº§ç”Ÿçš„é”™è¯¯ã€‚
        å¦‚ä½•å…³è”: è¿™æ˜¯æ•´ä¸ªç¨‹åºçš„èµ·ç‚¹ã€‚
    */
    let game;
    window.onload = () => {
        game = new Game();
        game.init();
    };
</script>
</body>
</html>
